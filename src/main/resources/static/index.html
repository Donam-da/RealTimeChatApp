<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App - Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Nút đăng xuất toàn cục -->
    <button onclick="logout()" id="logout-btn" class="logout-btn hidden">Đăng xuất</button>

    <div id="username-page">
        <div class="username-page-container">
            <div id="login-section">
                <h1 class="title">Đăng nhập</h1>
                <input type="text" id="login-username" placeholder="Tài khoản" autocomplete="off" />
                <input type="password" id="login-password" placeholder="Mật khẩu" />
                <button onclick="login()" class="accent username-submit">Đăng nhập</button>
                <p class="toggle-text">Chưa có tài khoản? <span onclick="showRegister()">Đăng ký ngay</span></p>
            </div>

            <div id="register-section" class="hidden">
                <h1 class="title">Đăng ký tài khoản</h1>
                <input type="text" id="reg-username" placeholder="Tên đăng nhập mới" autocomplete="off" />
                <input type="password" id="reg-password" placeholder="Mật khẩu mới" />
                <input type="text" id="reg-displayname" placeholder="Tên hiển thị (Tùy chọn)" autocomplete="off" />
                <button onclick="register()" class="accent username-submit" style="background-color: #0084ff;">Tạo tài khoản</button>
                <p class="toggle-text">Đã có tài khoản? <span onclick="showLogin()">Quay lại Đăng nhập</span></p>
            </div>
        </div>
    </div>

    <!-- Màn hình danh sách người dùng -->
    <div id="user-list-page" class="hidden">
        <h2 class="title" style="margin-bottom: 20px;">Chọn người để chat</h2>
        <div id="user-grid" class="user-grid">
            <!-- Các icon user sẽ được thêm vào đây bằng JS -->
        </div>
    </div>

    <div id="chat-page" class="hidden">
		<div class="chat-header">
		    <div class="header-info">
                <button onclick="backToUserList()" class="back-btn">&#8592;</button>
		        <h2 class="title" id="display-username">nam523181</h2>
		        <span class="status">Đang hoạt động</span>
		    </div>
		</div>

        <div class="chat-container">
            <ul id="messageArea"></ul>
            <form id="messageForm" name="messageForm">
                <input type="text" id="message" placeholder="Nhập tin nhắn..." autocomplete="off"/>
                <button type="submit">Gửi</button>
            </form>
        </div>
    </div>

    <script>
        var stompClient = null;
        var username = null; 
        var currentChatPartner = null; // Người đang chat cùng
        var currentSubscription = null; // Để quản lý việc hủy đăng ký topic cũ
        var allUsers = []; // Danh sách user

        // CHUYỂN ĐỔI GIAO DIỆN
        function showRegister() {
            document.querySelector('#login-section').classList.add('hidden');
            document.querySelector('#register-section').classList.remove('hidden');
        }

        function showLogin() {
            document.querySelector('#register-section').classList.add('hidden');
            document.querySelector('#login-section').classList.remove('hidden');
        }

        // ĐĂNG KÝ & ĐĂNG NHẬP
        function register() {
            const u = document.querySelector('#reg-username').value.trim();
            const p = document.querySelector('#reg-password').value.trim();
            const dn = document.querySelector('#reg-displayname').value.trim();
            if(!u || !p) { alert("Vui lòng nhập đủ tài khoản và mật khẩu"); return; }

            fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p, displayName: dn})
            }).then(res => res.text()).then(data => {
                alert(data);
                if(data === "Đăng ký thành công!") showLogin();
            });
        }

        function login() {
            const u = document.querySelector('#login-username').value.trim();
            const p = document.querySelector('#login-password').value.trim();

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            }).then(res => {
                if(res.ok) {
                    return res.json(); // Chuyển đổi phản hồi từ server sang JSON
                } else { throw new Error("Login failed"); }
            }).then(data => {
                // Ưu tiên sử dụng displayName (Tên hiển thị) nếu có, nếu không thì dùng username
                username = data.displayName || data.username;
                document.querySelector('#username-page').classList.add('hidden');
                fetchUserList(); // Lấy danh sách user thay vì vào chat ngay
                document.querySelector('#logout-btn').classList.remove('hidden'); // Hiện nút đăng xuất
                connectWebSocket(); // Kết nối socket sẵn
            }).catch(err => alert("Sai tài khoản hoặc mật khẩu!"));
        }

        function logout() {
            if (stompClient) {
                stompClient.disconnect(); // Ngắt kết nối WebSocket
            }
            username = null;
            currentChatPartner = null;
            document.querySelector('#chat-page').classList.add('hidden');
            document.querySelector('#user-list-page').classList.add('hidden');
            document.querySelector('#logout-btn').classList.add('hidden'); // Ẩn nút đăng xuất
            document.querySelector('#username-page').classList.remove('hidden');
        }

        // QUẢN LÝ DANH SÁCH USER
        function fetchUserList() {
            fetch('/api/auth/users')
                .then(res => res.json())
                .then(users => {
                    allUsers = users.filter(u => u.username !== document.querySelector('#login-username').value.trim()); // Loại bỏ chính mình
                    renderUserList();
                    document.querySelector('#user-list-page').classList.remove('hidden');
                });
        }

        function renderUserList() {
            const grid = document.querySelector('#user-grid');
            grid.innerHTML = '';
            allUsers.forEach(user => {
                const name = user.displayName || user.username;
                const card = document.createElement('div');
                card.className = 'user-card';
                card.onclick = () => startChat(user);

                const avatar = document.createElement('div');
                avatar.className = 'user-avatar-large';
                avatar.textContent = name.charAt(0);
                avatar.style.backgroundColor = getAvatarColor(name);

                const nameTag = document.createElement('div');
                nameTag.className = 'user-name-display';
                nameTag.textContent = name;

                card.append(avatar, nameTag);
                grid.appendChild(card);
            });
        }

        function startChat(partnerUser) {
            currentChatPartner = partnerUser;
            const partnerName = partnerUser.displayName || partnerUser.username;
            
            document.querySelector('#user-list-page').classList.add('hidden');
            document.querySelector('#chat-page').classList.remove('hidden');
            document.querySelector('#display-username').textContent = partnerName;
            document.querySelector('#messageArea').innerHTML = ''; // Xóa tin nhắn cũ
            
            // Tính toán Room ID (giống logic gửi tin nhắn)
            const myName = document.querySelector('#login-username').value.trim();
            const roomId = [myName, partnerUser.username].sort().join('_');

            subscribeToRoom();
            loadChatHistory(roomId); // Tải lịch sử chat
        }

        function loadChatHistory(roomId) {
            fetch('/api/messages/' + roomId)
                .then(res => res.json())
                .then(messages => {
                    messages.forEach(drawMessage);
                });
        }

        function backToUserList() {
            document.querySelector('#chat-page').classList.add('hidden');
            document.querySelector('#user-list-page').classList.remove('hidden');
            currentChatPartner = null;
            if (currentSubscription) currentSubscription.unsubscribe(); // Ngắt kết nối phòng chat hiện tại
        }

        // WEBSOCKET LOGIC
        function connectWebSocket() {
            var socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, () => console.log("Connected"), onError); 
        }

        function subscribeToRoom() {
            if (!stompClient || !currentChatPartner) return;
            
            // Tạo ID phòng duy nhất bằng cách sắp xếp tên 2 người (ví dụ: chat_nam_tuan)
            // Lưu ý: Đây là cách giả lập phòng chat riêng trên Frontend
            const myName = document.querySelector('#login-username').value.trim();
            const partnerName = currentChatPartner.username;
            const roomId = [myName, partnerName].sort().join('_');
            const topic = `/topic/${roomId}`;

            if (currentSubscription) currentSubscription.unsubscribe();
            currentSubscription = stompClient.subscribe(topic, onMessageReceived);
            
            // Gửi thông báo tham gia (tùy chọn)
            // stompClient.send("/app/chat.addUser", {}, JSON.stringify({sender: username, type: 'JOIN'}));
        }

        function onError(error) { console.error("Lỗi: " + error); }

        // Hàm tạo màu ngẫu nhiên dựa trên tên để avatar sinh động hơn
        function getAvatarColor(name) {
            var hash = 0;
            for (var i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            var c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function drawMessage(message) {
            var messageArea = document.querySelector('#messageArea');
            var messageLi = document.createElement('li');

            if(message.type === 'JOIN' || message.type === 'LEAVE') {
                messageLi.classList.add('event-message');
                messageLi.textContent = message.sender + (message.type === 'JOIN' ? " đã tham gia phòng" : " đã rời phòng");
            } else {
                var contentContainer = document.createElement('div');
                contentContainer.classList.add('message-content');
                if (message.sender === username) {
                    messageLi.classList.add('my-message-container');
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'my-bubble');
                    bubble.textContent = message.content;
                    contentContainer.appendChild(bubble);
                } else {
                    messageLi.classList.add('other-message-container');
                    var avatar = document.createElement('div');
                    avatar.classList.add('avatar');
                    avatar.textContent = message.sender.charAt(0); // Lấy chữ cái đầu
                    avatar.style.backgroundColor = getAvatarColor(message.sender);
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'other-bubble');
                    var senderName = document.createElement('div');
                    senderName.classList.add('sender-name');
                    senderName.textContent = message.sender;
                    var text = document.createElement('div');
                    text.textContent = message.content;
                    bubble.append(senderName, text);
                    contentContainer.append(avatar, bubble);
                }
                messageLi.appendChild(contentContainer);
            }
            messageArea.appendChild(messageLi);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function onMessageReceived(payload) { drawMessage(JSON.parse(payload.body)); }

        function sendMessage(event) {
            var input = document.querySelector('#message');
            var content = input.value.trim();
            if(content && stompClient && currentChatPartner) {
                // Gửi tin nhắn kèm theo topic ID để Backend biết gửi vào đâu (Nếu Backend hỗ trợ Dynamic Topic)
                // Hoặc nếu Backend chỉ broadcast public, ta cần sửa Backend.
                // Ở đây tôi giả định bạn sẽ sửa Backend để gửi lại đúng topic, hoặc dùng topic public nhưng lọc tin nhắn.
                // Cách đơn giản nhất với code hiện tại: Gửi vào topic chung nhưng client tự lọc (không bảo mật nhưng chạy được ngay)
                // Tuy nhiên, để đúng logic "Room", ta cần gửi topic vào header hoặc body.
                
                // Logic tạm thời: Gửi tin nhắn như cũ, nhưng Backend cần được cấu hình để broadcast lại đúng chỗ.
                // Để code chạy được ngay với Backend cũ (broadcast public), ta sẽ dùng logic lọc tin nhắn ở onMessageReceived (nếu cần).
                // Nhưng để "chuẩn", ta gửi tin nhắn vào topic riêng:
                
                // *LƯU Ý*: Bạn cần đảm bảo Backend ChatController nhận tin nhắn và gửi lại vào đúng topic.
                // Vì tôi không sửa được ChatController, tôi sẽ dùng cơ chế gửi vào topic public nhưng lọc hiển thị (nếu backend chưa sửa).
                // Nhưng code dưới đây giả định ta dùng cơ chế Room ID ở trên.
                
                const myName = document.querySelector('#login-username').value.trim();
                const partnerName = currentChatPartner.username;
                const roomId = [myName, partnerName].sort().join('_');
                
                // Gửi tin nhắn. Lưu ý: Backend cần hỗ trợ nhận tham số roomId hoặc destination
                // Nếu bạn chưa sửa Backend, tin nhắn này có thể sẽ được gửi public.
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                    sender: username, 
                    content: content, 
                    type: 'CHAT',
                    roomId: roomId // Gửi kèm ID phòng (Cần sửa Backend để xử lý cái này)
                }));
                
                input.value = '';
            }
            event.preventDefault();
        }

        document.querySelector('#messageForm').addEventListener('submit', sendMessage, true);
    </script>
</body>
</html>