<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App - Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

    <div id="username-page">
        <div class="username-page-container">
            <h1 class="title">Chào mừng bạn!</h1>
            <p>Vui lòng nhập tên để bắt đầu cuộc trò chuyện</p>
            <form id="usernameForm">
                <input type="text" id="name" placeholder="Tên của bạn..." autocomplete="off" required />
                <button type="submit" class="accent username-submit">Vào phòng Chat</button>
            </form>
        </div>
    </div>

    <div id="chat-page" class="hidden">
        <div class="chat-header">
            <div class="header-info">
                <h2 class="title" id="display-username">User Name</h2>
                <span class="status">Đang hoạt động</span>
            </div>
        </div>

        <div class="chat-container">
            <ul id="messageArea"></ul>
            
            <form id="messageForm" name="messageForm">
                <input type="text" id="message" placeholder="Nhập tin nhắn..." autocomplete="off"/>
                <button type="submit">Gửi</button>
            </form>
        </div>
    </div>

    <script>
        var stompClient = null;
        var username = null; // Sẽ được gán khi người dùng nhập tên
        var avatarUrl = "https://i.imgur.com/DY6gND0.png"; 

        var usernamePage = document.querySelector('#username-page');
        var chatPage = document.querySelector('#chat-page');
        var usernameForm = document.querySelector('#usernameForm');
        var messageForm = document.querySelector('#messageForm');

        // === HÀM KẾT NỐI (Chỉ chạy sau khi nhập tên) ===
        function connect(event) {
            username = document.querySelector('#name').value.trim();

            if(username) {
                // Ẩn trang chờ, hiện trang chat
                usernamePage.classList.add('hidden');
                chatPage.classList.remove('hidden');
                document.querySelector('#display-username').textContent = username;

                // Khởi tạo kết nối WebSocket
                var socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, onConnected, onError); 
            }
            event.preventDefault();
        }

        function onConnected() {
            // Đăng ký nhận tin nhắn
            stompClient.subscribe('/topic/public', onMessageReceived);

            // Tải lại lịch sử chat từ MySQL
            fetch('/chat/history')
                .then(response => response.json())
                .then(messages => {
                    messages.forEach(msg => drawMessage(msg));
                });

            // Thông báo cho mọi người có thành viên mới
            stompClient.send("/app/chat.addUser", {}, JSON.stringify({sender: username, type: 'JOIN'}));
        }

        function onError(error) {
            console.error("Lỗi kết nối: " + error);
            alert("Không thể kết nối đến máy chủ. Vui lòng thử lại!");
        }

        // === HÀM VẼ TIN NHẮN (Fix lỗi hàng dọc & thanh cuộn) ===
        function drawMessage(message) {
            var messageArea = document.querySelector('#messageArea');
            var messageLi = document.createElement('li');

            if(message.type === 'JOIN' || message.type === 'LEAVE') {
                messageLi.classList.add('event-message');
                messageLi.textContent = message.sender + (message.type === 'JOIN' ? " đã tham gia phòng" : " đã rời phòng");
            } else {
                var contentContainer = document.createElement('div');
                contentContainer.classList.add('message-content'); // Fix lỗi hiển thị hàng dọc

                if (message.sender === username) {
                    messageLi.classList.add('my-message-container');
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'my-bubble');
                    bubble.textContent = message.content;
                    contentContainer.appendChild(bubble);
                } else {
                    messageLi.classList.add('other-message-container');
                    
                    var avatar = document.createElement('img');
                    avatar.src = avatarUrl;
                    avatar.classList.add('avatar');

                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'other-bubble');
                    
                    var senderName = document.createElement('div');
                    senderName.classList.add('sender-name');
                    senderName.textContent = message.sender;

                    var messageContent = document.createElement('div');
                    messageContent.textContent = message.content;

                    bubble.appendChild(senderName);
                    bubble.appendChild(messageContent);
                    contentContainer.appendChild(avatar);
                    contentContainer.appendChild(bubble);
                }
                messageLi.appendChild(contentContainer);
            }

            messageArea.appendChild(messageLi);
            // Luôn cuộn xuống tin nhắn mới nhất
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function onMessageReceived(payload) {
            var message = JSON.parse(payload.body);
            drawMessage(message);
        }

        function sendMessage(event) {
            var messageInput = document.querySelector('#message');
            var messageContent = messageInput.value.trim();
            if(messageContent && stompClient) {
                var chatMessage = { sender: username, content: messageContent, type: 'CHAT' };
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
            event.preventDefault();
        }

        // Lắng nghe sự kiện submit
        usernameForm.addEventListener('submit', connect, true);
        messageForm.addEventListener('submit', sendMessage, true);
    </script>
</body>
</html>