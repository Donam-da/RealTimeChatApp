<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App - Pro</title>
    <link rel="stylesheet" href="style.css?v=7.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Header Controls (Logout + Profile) -->
    <div id="header-controls" class="header-controls hidden">
        <div class="profile-container">
            <div id="my-avatar" class="my-avatar" onclick="toggleMyProfileDropdown()"></div>
            <div id="my-profile-dropdown" class="my-profile-dropdown">
                <div class="dropdown-profile-header">
                    <div id="dropdown-avatar" class="dropdown-avatar"></div>
                    <div id="dropdown-displayname" class="dropdown-name"></div>
                </div>
                <a href="#" onclick="showEditProfile()">Ch·ªânh s·ª≠a h·ªì s∆° c√° nh√¢n</a>
                <a href="#" onclick="showChangePassword()">ƒê·ªïi m·∫≠t kh·∫©u</a>
                <a href="#" onclick="logout()" style="border-top: 1px solid #eee; color: #d32f2f;">ƒêƒÉng xu·∫•t</a>
            </div>
        </div>
    </div>

    <div id="username-page">
        <div class="username-page-container">
            <div id="login-section">
                <h1 class="title">ƒêƒÉng nh·∫≠p</h1>
                <input type="text" id="login-username" placeholder="T√†i kho·∫£n" autocomplete="off" />
                <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u" />
                <button onclick="login()" class="accent username-submit">ƒêƒÉng nh·∫≠p</button>
                <p class="toggle-text">Ch∆∞a c√≥ t√†i kho·∫£n? <span onclick="showRegister()">ƒêƒÉng k√Ω ngay</span></p>
            </div>

            <div id="register-section" class="hidden">
                <h1 class="title">ƒêƒÉng k√Ω t√†i kho·∫£n</h1>
                <input type="text" id="reg-username" placeholder="T√™n ƒëƒÉng nh·∫≠p m·ªõi" autocomplete="off" />
                <input type="password" id="reg-password" placeholder="M·∫≠t kh·∫©u m·ªõi" />
                <input type="text" id="reg-displayname" placeholder="T√™n hi·ªÉn th·ªã (T√πy ch·ªçn)" autocomplete="off" />
                <button onclick="register()" class="accent username-submit" style="background-color: #0084ff;">T·∫°o t√†i kho·∫£n</button>
                <p class="toggle-text">ƒê√£ c√≥ t√†i kho·∫£n? <span onclick="showLogin()">Quay l·∫°i ƒêƒÉng nh·∫≠p</span></p>
            </div>
        </div>
    </div>

    <!-- M√†n h√¨nh danh s√°ch ng∆∞·ªùi d√πng -->
    <div id="user-list-page" class="hidden">
        <h2 class="title" style="margin-bottom: 20px;">Ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat</h2>
        <div id="user-grid" class="user-grid">
            <!-- C√°c icon user s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
        </div>
    </div>

    <!-- Tr√¨nh xem ·∫£nh to√†n m√†n h√¨nh -->
    <div id="image-viewer-overlay" onclick="closeImageViewer()">
        <button class="viewer-close-btn">&times;</button>
        <img id="image-viewer-img" src="" alt="Full Screen Image" onclick="event.stopPropagation()">
        <div id="image-viewer-thumbnails" class="viewer-thumbnails" onclick="event.stopPropagation()"></div>
    </div>

    <!-- Modal Ch·ªânh s·ª≠a h·ªì s∆° -->
    <div id="edit-profile-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditProfile()">&times;</span>
            <h2 style="margin-bottom: 10px;">Ch·ªânh s·ª≠a h·ªì s∆°</h2>
            <div class="edit-avatar-section">
                <div id="edit-avatar-preview" class="avatar-preview" onclick="onAvatarPreviewClick()"></div>
                <label class="upload-btn">
                    ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán
                    <input type="file" id="avatar-input" accept="image/*" onchange="handleEditAvatarSelect(event)" style="display: none;">
                </label>
            </div>
            <label class="modal-label">
                T√™n hi·ªÉn th·ªã
                <input type="text" id="edit-displayname" placeholder="T√™n hi·ªÉn th·ªã" class="modal-input">
            </label>
            <label class="modal-label">
                X√°c nh·∫≠n m·∫≠t kh·∫©u
                <input type="password" id="edit-confirm-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ l∆∞u thay ƒë·ªïi" class="modal-input">
            </label>
            <button onclick="saveProfile()" class="save-btn">L∆∞u thay ƒë·ªïi</button>
        </div>
    </div>

    <!-- Modal ƒê·ªïi m·∫≠t kh·∫©u -->
    <div id="change-password-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="closeChangePassword()">&times;</span>
            <h2 style="margin-bottom: 20px;">ƒê·ªïi m·∫≠t kh·∫©u</h2>
            <label class="modal-label">
                M·∫≠t kh·∫©u hi·ªán t·∫°i
                <input type="password" id="current-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" class="modal-input">
            </label>
            <label class="modal-label">
                M·∫≠t kh·∫©u m·ªõi
                <input type="password" id="new-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" class="modal-input">
            </label>
            <label class="modal-label">
                X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi
                <input type="password" id="confirm-password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" class="modal-input">
            </label>
            <button onclick="savePassword()" class="save-btn">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
        </div>
    </div>

    <!-- Modal C·∫Øt ·∫£nh (Crop Avatar) -->
    <div id="crop-avatar-modal" class="crop-modal">
        <div class="crop-content">
            <div class="crop-header">C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán</div>
            <div class="crop-body" id="crop-body">
                <img id="crop-image" src="" alt="Crop Image">
                <div class="crop-mask"></div>
            </div>
            <div class="crop-controls">
                <div class="crop-actions">
                    <button class="btn-cancel" onclick="closeCropModal()">H·ªßy</button>
                    <button class="btn-save" onclick="saveCrop()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal T√πy ch·ªçn G·ª° tin nh·∫Øn -->
    <div id="remove-msg-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="closeRemoveMsgModal()">&times;</span>
            <h2 id="remove-msg-title" style="margin-bottom: 10px;">B·∫°n mu·ªën g·ª° tin nh·∫Øn n√†y?</h2>
            <p id="remove-msg-desc" style="font-size: 13px; color: #65676b; margin-bottom: 10px;">Tin nh·∫Øn s·∫Ω b·ªã g·ª° kh·ªèi ƒëo·∫°n chat.</p>
            <div id="remove-msg-actions" class="remove-msg-options">
                <!-- C√°c n√∫t s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS t√πy v√†o ng∆∞·ªùi g·ª≠i -->
            </div>
        </div>
    </div>

    <script>
        var stompClient = null;
        var username = null; 
        var myDisplayName = null; // Bi·∫øn l∆∞u t√™n hi·ªÉn th·ªã c·ªßa m√¨nh
        var myAvatarData = null; // Bi·∫øn l∆∞u avatar c·ªßa m√¨nh
        var activeChats = {}; // L∆∞u tr·ªØ c√°c c·ª≠a s·ªï chat ƒëang m·ªü: { 'username': { element, subscription, roomId } }
        var allUsers = []; // Danh s√°ch user
        var pendingRawAvatar = null; // L∆∞u ·∫£nh g·ªëc khi ƒëang ch·ªânh s·ª≠a
        var selectedMessageId = null; // ID tin nh·∫Øn ƒëang ch·ªçn ƒë·ªÉ x√≥a

        // CHUY·ªÇN ƒê·ªîI GIAO DI·ªÜN
        function showRegister() {
            document.querySelector('#login-section').classList.add('hidden');
            document.querySelector('#register-section').classList.remove('hidden');
        }

        function showLogin() {
            document.querySelector('#register-section').classList.add('hidden');
            document.querySelector('#login-section').classList.remove('hidden');
        }

        // ƒêƒÇNG K√ù & ƒêƒÇNG NH·∫¨P
        function register() {
            const u = document.querySelector('#reg-username').value.trim();
            const p = document.querySelector('#reg-password').value.trim();
            const dn = document.querySelector('#reg-displayname').value.trim();
            if(!u || !p) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß t√†i kho·∫£n v√† m·∫≠t kh·∫©u"); return; }

            fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p, displayName: dn})
            }).then(res => res.text()).then(data => {
                alert(data);
                if(data === "ƒêƒÉng k√Ω th√†nh c√¥ng!") showLogin();
            });
        }

        function login() {
            const u = document.querySelector('#login-username').value.trim();
            const p = document.querySelector('#login-password').value.trim();

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            }).then(res => {
                if(res.ok) {
                    return res.json(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi t·ª´ server sang JSON
                } else { throw new Error("Login failed"); }
            }).then(data => {
                // ∆Øu ti√™n s·ª≠ d·ª•ng displayName (T√™n hi·ªÉn th·ªã) n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng username
                username = data.username; // QUAN TR·ªåNG: Gi·ªØ nguy√™n username g·ªëc ƒë·ªÉ ƒë·ªãnh danh
                myDisplayName = data.displayName || data.username; // L∆∞u t√™n hi·ªÉn th·ªã ri√™ng
                myAvatarData = data.avatar; // L∆∞u avatar
                document.querySelector('#username-page').classList.add('hidden');
                fetchUserList(); // L·∫•y danh s√°ch user thay v√¨ v√†o chat ngay
                
                // Hi·ªÉn th·ªã header controls v√† c·∫≠p nh·∫≠t avatar
                const headerControls = document.getElementById('header-controls');
                headerControls.classList.remove('hidden');
                setElementAvatar(document.getElementById('my-avatar'), myDisplayName, myAvatarData);
                
                // C·∫≠p nh·∫≠t th√¥ng tin trong dropdown menu
                setElementAvatar(document.getElementById('dropdown-avatar'), myDisplayName, myAvatarData);
                document.getElementById('dropdown-displayname').textContent = myDisplayName;

                connectWebSocket(); // K·∫øt n·ªëi socket s·∫µn
            }).catch(err => alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!"));
        }

        function logout() {
            // G·ªçi API logout ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i Offline tr√™n server
            if (username) {
                fetch('/api/auth/logout', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: username}) });
            }

            if (stompClient) {
                stompClient.disconnect(); // Ng·∫Øt k·∫øt n·ªëi WebSocket
            }
            username = null;
            myAvatarData = null;
            // X√≥a t·∫•t c·∫£ c·ª≠a s·ªï chat
            Object.keys(activeChats).forEach(u => closeChatWindow(u));
            activeChats = {};
            document.querySelector('#user-list-page').classList.add('hidden');
            document.getElementById('header-controls').classList.add('hidden'); // ·∫®n header controls
            document.querySelector('#username-page').classList.remove('hidden');
        }

        // QU·∫¢N L√ù DANH S√ÅCH USER
        function fetchUserList() {
            fetch('/api/auth/users')
                .then(res => res.json())
                .then(users => {
                    allUsers = users.filter(u => u.username !== document.querySelector('#login-username').value.trim()); // Lo·∫°i b·ªè ch√≠nh m√¨nh
                    // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i cho c√°c c·ª≠a s·ªï chat ƒëang m·ªü (n·∫øu c√≥)
                    allUsers.forEach(u => {
                        if (activeChats[u.username]) {
                            updateStatusUI(u.username, u.status, u.lastActive);
                        }
                    });
                    renderUserList();
                    document.querySelector('#user-list-page').classList.remove('hidden');
                });
        }

        function renderUserList() {
            const grid = document.querySelector('#user-grid');
            grid.innerHTML = '';
            allUsers.forEach(user => {
                const name = user.displayName || user.username;
                const card = document.createElement('div');
                card.className = 'user-card';
                card.onclick = () => startChat(user);

                // Container b·ªçc avatar ƒë·ªÉ ƒë·ªãnh v·ªã ch·∫•m tr·∫°ng th√°i
                const avatarContainer = document.createElement('div');
                avatarContainer.className = 'user-avatar-container';

                const avatar = document.createElement('div');
                avatar.className = 'user-avatar-large';
                setElementAvatar(avatar, name, user.avatar);

                // Badge tr·∫°ng th√°i
                const statusBadge = document.createElement('div');
                statusBadge.className = 'status-badge';
                if (user.status === 'ONLINE') statusBadge.classList.add('status-online');
                else { statusBadge.classList.add('status-offline'); statusBadge.textContent = getShortTime(user.lastActive); }

                avatarContainer.append(avatar, statusBadge);
                const nameTag = document.createElement('div');
                nameTag.className = 'user-name-display';
                nameTag.textContent = name;

                card.append(avatarContainer, nameTag);
                grid.appendChild(card);
            });
        }

        function startChat(partnerUser) {
            const partnerUsername = partnerUser.username;
            const partnerName = partnerUser.displayName || partnerUser.username;
            
            // N·∫øu ƒë√£ m·ªü r·ªìi th√¨ kh√¥ng l√†m g√¨ (ho·∫∑c c√≥ th·ªÉ focus v√†o n√≥)
            if (activeChats[partnerUsername]) return;

            // T√≠nh to√°n Room ID
            const myName = document.querySelector('#login-username').value.trim();
            const roomId = [myName, partnerUsername].sort().join('_');

            createChatWindowUI(partnerUser, roomId);
            subscribeToRoom(partnerUsername, roomId);
            loadChatHistory(roomId, partnerUsername, partnerName);
            sendReadReceipt(partnerUsername, roomId); // B√°o ƒë√£ xem ngay khi m·ªü chat
            updateStatusUI(partnerUsername, partnerUser.status, partnerUser.lastActive); // Hi·ªÉn th·ªã tr·∫°ng th√°i ban ƒë·∫ßu
        }

        function createChatWindowUI(partnerUser, roomId) {
            const partnerUsername = partnerUser.username;
            const partnerName = partnerUser.displayName || partnerUser.username;

            // Chu·∫©n b·ªã tr·∫°ng th√°i ban ƒë·∫ßu cho badge tr√™n header
            let badgeClass = 'status-badge header-status-badge';
            let badgeContent = '';
            if (partnerUser.status === 'ONLINE') {
                badgeClass += ' status-online';
            } else {
                badgeClass += ' hidden';
            }

            // T·∫°o khung chat
            const chatWindow = document.createElement('div');
            chatWindow.className = 'chat-window';
            chatWindow.id = 'chat-window-' + partnerUsername;
            
            // T√≠nh to√°n v·ªã tr√≠ (c√°ch ph·∫£i 20px, m·ªói c·ª≠a s·ªï c√°ch nhau 340px)
            const offset = 20 + (Object.keys(activeChats).length * 340);
            chatWindow.style.right = offset + 'px';

            chatWindow.innerHTML = `
                <div class="chat-window-header">
                    <div style="display: flex; align-items: center;">
                        <div class="chat-header-avatar-container">
                            <div class="chat-header-avatar" id="header-avatar-${partnerUsername}"></div>
                            <div id="header-status-${partnerUsername}" class="${badgeClass}">${badgeContent}</div>
                        </div>
                        <div style="display: flex; align-items: flex-start;">
                            <div style="display: flex; flex-direction: column;">
                                <span class="chat-window-title">${partnerName}</span>
                                <span class="chat-window-status" id="status-${partnerUsername}">ƒêang t·∫£i...</span>
                            </div>
                            <div class="dropdown" style="margin-left: 2px; margin-top: 2px;">
                                <button class="dropdown-btn" onclick="toggleDropdown('${partnerUsername}')">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </button>
                                <div id="dropdown-${partnerUsername}" class="dropdown-content">
                                    <a href="#" onclick="deleteChat('${partnerUsername}')">X√≥a ƒëo·∫°n chat</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="close-chat-btn" onclick="closeChatWindow('${partnerUsername}')">&times;</button>
                </div>
                <ul class="chat-window-body" id="msg-area-${partnerUsername}"></ul>
                <div class="chat-window-footer">
                    <div id="typing-${partnerUsername}" class="typing-indicator"></div>
                    <div id="preview-container-${partnerUsername}" class="image-preview-container">
                        <img id="preview-img-${partnerUsername}" class="image-preview" src="" alt="Preview">
                        <div class="remove-image-btn" onclick="removeImage('${partnerUsername}')">&times;</div>
                    </div>
                    <form onsubmit="sendMessage(event, '${partnerUsername}')">
                        <label class="attach-btn" title="G·ª≠i ·∫£nh">
                            <input type="file" accept="image/*" style="display: none" onchange="handleFileSelect(event, '${partnerUsername}')">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                            </svg>
                        </label>
                        <textarea placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1" oninput="autoResize(this); handleTyping('${partnerUsername}')" onkeydown="handleEnter(event, '${partnerUsername}')"></textarea>
                        <button type="submit">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            `;

            document.body.appendChild(chatWindow);
            
            // C·∫≠p nh·∫≠t avatar cho header chat
            setElementAvatar(document.getElementById(`header-avatar-${partnerUsername}`), partnerName, partnerUser.avatar);
            
            // L∆∞u v√†o state
            activeChats[partnerUsername] = {
                element: chatWindow,
                roomId: roomId,
                subscription: null,
                typingTimeout: null, // ƒê·ªÉ qu·∫£n l√Ω th·ªùi gian ·∫©n th√¥ng b√°o
                status: partnerUser.status,
                lastActive: partnerUser.lastActive,
                pendingImage: null // L∆∞u tr·ªØ ·∫£nh ƒëang ch·ªù g·ª≠i
            };
        }

        function closeChatWindow(partnerUsername) {
            if (activeChats[partnerUsername]) {
                // H·ªßy ƒëƒÉng k√Ω socket
                if (activeChats[partnerUsername].subscription) {
                    activeChats[partnerUsername].subscription.unsubscribe();
                }
                // X√≥a DOM
                activeChats[partnerUsername].element.remove();
                delete activeChats[partnerUsername];
                
                // S·∫Øp x·∫øp l·∫°i v·ªã tr√≠ c√°c c·ª≠a s·ªï c√≤n l·∫°i
                repositionChatWindows();
            }
        }

        function repositionChatWindows() {
            const keys = Object.keys(activeChats);
            keys.forEach((key, index) => {
                const offset = 20 + (index * 340);
                activeChats[key].element.style.right = offset + 'px';
            });
        }

        // --- DROPDOWN & DELETE CHAT ---
        function toggleDropdown(username) {
            document.getElementById("dropdown-" + username).classList.toggle("show");
        }

        // --- PROFILE DROPDOWN ---
        function toggleMyProfileDropdown() {
            document.getElementById("my-profile-dropdown").classList.toggle("show");
        }
        
        function showEditProfile() {
            document.getElementById('edit-profile-modal').classList.remove('hidden');
            document.getElementById('edit-displayname').value = myDisplayName;
            document.getElementById('edit-confirm-password').value = '';
            pendingRawAvatar = null; // Reset ·∫£nh t·∫°m
            
            // Preview avatar hi·ªán t·∫°i
            const preview = document.getElementById('edit-avatar-preview');
            setElementAvatar(preview, myDisplayName, myAvatarData);
            
            // ·∫®n dropdown profile
            document.getElementById("my-profile-dropdown").classList.remove("show");
        }

        function closeEditProfile() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
            pendingRawAvatar = null;
        }

        // --- ƒê·ªîI M·∫¨T KH·∫®U ---
        function showChangePassword() {
            document.getElementById('change-password-modal').classList.remove('hidden');
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById("my-profile-dropdown").classList.remove("show");
        }

        function closeChangePassword() {
            document.getElementById('change-password-modal').classList.add('hidden');
        }

        function savePassword() {
            const btn = document.querySelector('#change-password-modal .save-btn');
            const originalText = "C·∫≠p nh·∫≠t m·∫≠t kh·∫©u"; 
            
            // 1. Kh√≥a n√∫t ngay l·∫≠p t·ª©c
            btn.disabled = true;
            btn.textContent = "ƒêang x·ª≠ l√Ω...";

            try {
                const currentPass = document.getElementById('current-password').value.trim();
                const newPassword = document.getElementById('new-password').value.trim();
                const confirmPass = document.getElementById('confirm-password').value.trim();

                if (!currentPass || !newPassword || !confirmPass) throw new Error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                if (newPassword !== confirmPass) throw new Error("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!");
                if (!username) throw new Error("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");

                const updateData = { username: username, oldPassword: currentPass, newPassword: newPassword };

                // Ki·ªÉm tra h·ªó tr·ª£ AbortController (ƒë·ªÉ tr√°nh l·ªói tr√™n tr√¨nh duy·ªát c≈©)
                let signal = null;
                let timeoutId = null;
                if (window.AbortController) {
                    const controller = new AbortController();
                    signal = controller.signal;
                    timeoutId = setTimeout(() => controller.abort(), 10000);
                }

                fetch('/api/auth/change-password', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(updateData),
                    signal: signal
                }).then(res => {
                    if (timeoutId) clearTimeout(timeoutId);
                    if (res.ok) return res.text();
                    if (res.status === 404) throw new Error("API ch∆∞a t·ªìn t·∫°i. Vui l√≤ng kh·ªüi ƒë·ªông l·∫°i Server (Backend)!");
                    return res.text().then(text => { throw new Error(text) });
                }).then(msg => {
                    alert(msg);
                    closeChangePassword();
                }).catch(err => {
                    if (err.name === 'AbortError') {
                        alert("H·∫øt th·ªùi gian ch·ªù! Server kh√¥ng ph·∫£n h·ªìi.");
                    } else {
                        console.error(err);
                        alert("L·ªói: " + err.message);
                    }
                }).finally(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
            } catch (e) {
                // B·∫Øt l·ªói ƒë·ªìng b·ªô (v√≠ d·ª•: l·ªói bi·∫øn, l·ªói tr√¨nh duy·ªát)
                console.error("L·ªói client:", e);
                alert(e.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function onAvatarPreviewClick() {
            if (pendingRawAvatar) {
                openCropModal(pendingRawAvatar); // M·ªü l·∫°i ·∫£nh g·ªëc ƒë·ªÉ c·∫Øt l·∫°i
            } else if (myAvatarData) {
                openCropModal(myAvatarData); // Ch·ªânh s·ª≠a ·∫£nh hi·ªán t·∫°i
            } else {
                document.getElementById('avatar-input').click(); // Ch·ªçn ·∫£nh m·ªõi
            }
        }

        function handleEditAvatarSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingRawAvatar = e.target.result;
                    openCropModal(pendingRawAvatar);
                };
                reader.readAsDataURL(file);
            }
            event.target.value = ''; // Reset input ƒë·ªÉ ch·ªçn l·∫°i c√πng file n·∫øu mu·ªën
        }

        function saveProfile() {
            const newDisplayName = document.getElementById('edit-displayname').value.trim();
            const confirmPassword = document.getElementById('edit-confirm-password').value.trim();
            const newAvatar = document.getElementById('edit-avatar-preview').dataset.newAvatar || null;

            if (!confirmPassword) {
                alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n thay ƒë·ªïi!");
                return;
            }

            const updateData = { username: username, displayName: newDisplayName, currentPassword: confirmPassword };
            if (newAvatar) updateData.avatar = newAvatar;

            fetch('/api/auth/update', {
                method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(updateData)
            }).then(res => {
                if (res.ok) return res.json();
                return res.text().then(text => { throw new Error(text) });
            }).then(updatedUser => {
                alert("C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!");
                myDisplayName = updatedUser.displayName;
                if (updatedUser.avatar) myAvatarData = updatedUser.avatar;
                
                // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                setElementAvatar(document.getElementById('my-avatar'), myDisplayName, myAvatarData);
                
                // C·∫≠p nh·∫≠t th√¥ng tin trong dropdown menu
                setElementAvatar(document.getElementById('dropdown-avatar'), myDisplayName, myAvatarData);
                document.getElementById('dropdown-displayname').textContent = myDisplayName;

                pendingRawAvatar = null;
                closeEditProfile();
            }).catch(err => alert(err.message));
        }

        // ƒê√≥ng dropdown khi click ra ngo√†i
        window.onclick = function(event) {
            if (!event.target.closest('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
            // ƒê√≥ng profile dropdown
            if (!event.target.closest('.my-avatar')) {
                const profileDropdown = document.getElementById('my-profile-dropdown');
                if (profileDropdown && profileDropdown.classList.contains('show')) {
                    profileDropdown.classList.remove('show');
                }
            }
        }

        function deleteChat(partnerUsername) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô tin nh·∫Øn v·ªõi ng∆∞·ªùi n√†y?")) return;
            
            const roomId = activeChats[partnerUsername].roomId;
            // Truy·ªÅn th√™m username ƒë·ªÉ server bi·∫øt ai ƒëang x√≥a
            fetch('/api/messages/' + roomId + '?username=' + username, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        document.querySelector('#msg-area-' + partnerUsername).innerHTML = '';
                        alert("ƒê√£ x√≥a ƒëo·∫°n chat!");
                    } else {
                        alert("L·ªói khi x√≥a chat");
                    }
                });
        }

        function loadChatHistory(roomId, partnerUsername, partnerName) {
            // Truy·ªÅn th√™m username ƒë·ªÉ server l·ªçc tin nh·∫Øn ƒë√£ x√≥a
            fetch('/api/messages/' + roomId + '?username=' + username)
                .then(res => res.json())
                .then(messages => {
                    messages.forEach(msg => drawMessage(msg, partnerUsername));
                    
                    // Sau khi t·∫£i l·ªãch s·ª≠, ki·ªÉm tra xem tin nh·∫Øn cu·ªëi c√πng c·ªßa m√¨nh ƒë√£ ƒë∆∞·ª£c xem ch∆∞a
                    const myMsgs = messages.filter(m => m.sender === username);
                    if (myMsgs.length > 0) {
                        const lastMsg = myMsgs[myMsgs.length - 1];
                        if (lastMsg.status === 'READ') {
                            // Gi·∫£ l·∫≠p s·ª± ki·ªán READ ƒë·ªÉ v·∫Ω icon
                            drawMessage({ type: 'READ', sender: partnerUsername }, partnerUsername);
                        }
                    }
                });
        }

        // WEBSOCKET LOGIC
        function connectWebSocket() {
            var socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
                console.log("Connected");
                subscribeToPresence(); // L·∫Øng nghe tr·∫°ng th√°i Online/Offline
            }, onError); 
        }

        // L·∫Øng nghe tr·∫°ng th√°i ng∆∞·ªùi d√πng to√†n c·ª•c
        function subscribeToPresence() {
            stompClient.subscribe('/topic/presence', (payload) => {
                const msg = JSON.parse(payload.body);
                if (msg.type === 'STATUS') {
                    // C·∫≠p nh·∫≠t UI n·∫øu ƒëang m·ªü chat v·ªõi ng∆∞·ªùi n√†y
                    if (activeChats[msg.sender]) {
                        updateStatusUI(msg.sender, msg.content, msg.timestamp);
                    }
                    // C·∫≠p nh·∫≠t danh s√°ch user ng·∫ßm ƒë·ªãnh (ƒë·ªÉ l·∫ßn sau m·ªü chat c√≥ d·ªØ li·ªáu m·ªõi)
                    const userInList = allUsers.find(u => u.username === msg.sender);
                    if (userInList) {
                        userInList.status = msg.content;
                        userInList.lastActive = msg.timestamp;
                        // N·∫øu ƒëang ·ªü trang danh s√°ch th√¨ render l·∫°i ngay ƒë·ªÉ c·∫≠p nh·∫≠t ch·∫•m xanh
                        if (!document.querySelector('#user-list-page').classList.contains('hidden')) {
                            renderUserList();
                        }
                    }
                }
            });
        }

        function subscribeToRoom(partnerUsername, roomId) {
            if (!stompClient) return;
            const topic = `/topic/${roomId}`;
            
            // ƒêƒÉng k√Ω v√† l∆∞u subscription v√†o activeChats ƒë·ªÉ sau n√†y h·ªßy
            const sub = stompClient.subscribe(topic, (payload) => {
                const msg = JSON.parse(payload.body);
                drawMessage(msg, partnerUsername);
                // N·∫øu nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn CHAT t·ª´ ng∆∞·ªùi kia, b√°o ƒë√£ xem ngay
                if (msg.type === 'CHAT' && msg.sender !== username) {
                    sendReadReceipt(partnerUsername, roomId);
                }
                // N·∫øu nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn REVOKED (Thu h·ªìi)
                if (msg.type === 'REVOKED') {
                    // Reload l·∫°i chat ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán (ƒë∆°n gi·∫£n nh·∫•t)
                    // Ho·∫∑c t√¨m v√† update DOM n·∫øu mu·ªën t·ªëi ∆∞u
                    const msgArea = document.querySelector(`#msg-area-${partnerUsername}`);
                    msgArea.innerHTML = '';
                    loadChatHistory(roomId, partnerUsername, getDisplayName(partnerUsername));
                }
                // X·ª≠ l√Ω s·ª± ki·ªán REACT (Th·∫£ c·∫£m x√∫c)
                if (msg.type === 'REACT') {
                    // T√¨m tin nh·∫Øn trong DOM v√† c·∫≠p nh·∫≠t reactions
                    const msgEl = document.getElementById(`msg-${msg.id}`);
                    if (msgEl) {
                        const bubble = msgEl.querySelector('.bubble');
                        if (bubble) {
                            renderReactionsOnBubble(bubble, msg.reactions);
                        }
                    }
                }
                // X·ª≠ l√Ω s·ª± ki·ªán TYPING
                if (msg.type === 'TYPING' && msg.sender !== username) {
                    showTypingIndicator(partnerUsername, msg.sender);
                }
            });
            
            if (activeChats[partnerUsername]) {
                activeChats[partnerUsername].subscription = sub;
            }
        }

        function onError(error) { console.error("L·ªói: " + error); }

        // T·ª± ƒë·ªông ƒëƒÉng xu·∫•t khi ƒë√≥ng tab/tr√¨nh duy·ªát
        window.addEventListener('beforeunload', function (e) {
            if (username) {
                var data = JSON.stringify({username: username});
                var blob = new Blob([data], {type: 'application/json'});
                navigator.sendBeacon('/api/auth/logout', blob);
            }
        });

        // H√†m t·∫°o m√†u ng·∫´u nhi√™n d·ª±a tr√™n t√™n ƒë·ªÉ avatar sinh ƒë·ªông h∆°n
        function getAvatarColor(name) {
            var hash = 0;
            for (var i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            var c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // H√†m helper ƒë·ªÉ set avatar (·∫£nh ho·∫∑c ch·ªØ)
        function setElementAvatar(el, name, avatarBase64) {
            el.style.backgroundSize = 'cover';
            el.style.backgroundPosition = 'center';
            if (avatarBase64) {
                el.style.backgroundImage = `url(${avatarBase64})`;
                el.textContent = '';
                el.style.backgroundColor = 'transparent';
            } else {
                el.style.backgroundImage = 'none';
                el.textContent = name ? name.charAt(0) : '?';
                el.style.backgroundColor = getAvatarColor(name || 'User');
            }
        }

        function getDisplayName(userId) {
            if (userId === username) return myDisplayName;
            const u = allUsers.find(user => user.username === userId);
            return u ? (u.displayName || u.username) : userId;
        }

        function drawMessage(message, partnerUsername) {
            // T√¨m ƒë√∫ng khung chat ƒë·ªÉ v·∫Ω tin nh·∫Øn
            var messageArea = document.querySelector(`#msg-area-${partnerUsername}`);
            if (!messageArea) return; // N·∫øu c·ª≠a s·ªï chat ƒë√£ ƒë√≥ng th√¨ b·ªè qua

            var messageLi = document.createElement('li');
            messageLi.id = `msg-${message.id}`; // Th√™m ID ƒë·ªÉ d·ªÖ d√†ng x√≥a

            // X·ª≠ l√Ω s·ª± ki·ªán ƒê√É XEM (READ)
            if (message.type === 'READ') {
                if (message.sender !== username) { // Ng∆∞·ªùi kia ƒë√£ ƒë·ªçc tin nh·∫Øn c·ªßa m√¨nh
                    // X√≥a icon c≈©
                    const oldIcons = document.querySelectorAll(`#msg-area-${partnerUsername} .seen-icon`);
                    oldIcons.forEach(el => el.remove());

                    // T√¨m tin nh·∫Øn cu·ªëi c√πng c·ªßa m√¨nh ƒë·ªÉ g·∫Øn icon
                    const myMsgs = document.querySelectorAll(`#msg-area-${partnerUsername} .my-message-container`);
                    if(myMsgs.length > 0) {
                        const lastMsg = myMsgs[myMsgs.length - 1];
                        addSeenIcon(lastMsg, message.sender);
                    }
                }
                return; // Kh√¥ng v·∫Ω tin nh·∫Øn, ch·ªâ x·ª≠ l√Ω icon
            }

            // X·ª≠ l√Ω s·ª± ki·ªán TYPING (Kh√¥ng v·∫Ω tin nh·∫Øn)
            if (message.type === 'TYPING') {
                return;
            }

            // X·ª≠ l√Ω s·ª± ki·ªán REACT (Kh√¥ng v·∫Ω tin nh·∫Øn m·ªõi)
            if (message.type === 'REACT') {
                return;
            }

            // --- X·ª¨ L√ù D√íNG TH·ªúI GIAN (SEPARATOR) ---
            var currentMsgDate = parseDate(message.timestamp);
            var currentTimestamp = currentMsgDate ? currentMsgDate.getTime() : Date.now();
            
            // T√¨m tin nh·∫Øn g·∫ßn nh·∫•t tr∆∞·ªõc ƒë√≥ (c√≥ attribute data-timestamp)
            const previousMsgs = messageArea.querySelectorAll('li[data-timestamp]');
            
            if (previousMsgs.length === 0) {
                addDateSeparator(message.timestamp, partnerUsername);
            } else {
                const lastMsg = previousMsgs[previousMsgs.length - 1];
                const lastTimestamp = parseInt(lastMsg.getAttribute('data-timestamp'));
                // N·∫øu c√°ch nhau qu√° 5 ph√∫t (300000 ms) th√¨ hi·ªán l·∫°i d√≤ng th·ªùi gian
                if (currentTimestamp - lastTimestamp > 5 * 60 * 1000) {
                    addDateSeparator(message.timestamp, partnerUsername);
                }
            }
            
            // L∆∞u timestamp v√†o th·∫ª li ƒë·ªÉ d√πng cho l·∫ßn so s√°nh ti·∫øp theo
            messageLi.setAttribute('data-timestamp', currentTimestamp);

            if(message.type === 'JOIN' || message.type === 'LEAVE') {
                messageLi.classList.add('event-message');
                messageLi.textContent = message.sender + (message.type === 'JOIN' ? " ƒë√£ tham gia ph√≤ng" : " ƒë√£ r·ªùi ph√≤ng");
            } else {
                // L·∫•y th√¥ng tin user ƒë·ªÉ hi·ªÉn th·ªã avatar
                const senderUser = allUsers.find(u => u.username === message.sender);
                const senderAvatarData = (message.sender === username) ? myAvatarData : (senderUser ? senderUser.avatar : null);

                var senderDisplayName = getDisplayName(message.sender);
                var timeString = formatTime(message.timestamp); // L·∫•y gi·ªù:ph√∫t
                var contentContainer = document.createElement('div');
                contentContainer.classList.add('message-content');
                if (message.sender === username) {
                    // Tin nh·∫Øn c·ªßa m√¨nh
                    messageLi.classList.add('my-message-container');
                    
                    // Th√™m n√∫t Actions (3 ch·∫•m + m·∫∑t c∆∞·ªùi) TR∆Ø·ªöC bong b√≥ng chat
                    if (message.type !== 'REVOKED') addMessageOptions(contentContainer, message, true);

                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'my-bubble');
                    
                    if (message.type === 'REVOKED') {
                        bubble.classList.add('revoked-bubble');
                        bubble.textContent = message.content;
                    } else if (message.type === 'IMAGE') {
                        bubble.classList.add('image-bubble');
                        bubble.innerHTML = `<img src="${message.content}" class="chat-image" onclick="openImageViewer(this)">`;
                    } else {
                        bubble.textContent = message.content;
                    }
                    if (timeString) bubble.innerHTML += `<span class="message-time">${timeString}</span>`;
                    
                    // Hi·ªÉn th·ªã reactions n·∫øu c√≥
                    renderReactionsOnBubble(bubble, message.reactions);

                    contentContainer.appendChild(bubble);
                } else {
                    // Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c
                    messageLi.classList.add('other-message-container');
                    var avatar = document.createElement('div');
                    avatar.classList.add('avatar');
                    setElementAvatar(avatar, senderDisplayName, senderAvatarData);
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'other-bubble');
                    
                    if (message.type === 'REVOKED') {
                        bubble.classList.add('revoked-bubble');
                        bubble.textContent = message.content;
                    } else if (message.type === 'IMAGE') {
                        bubble.classList.add('image-bubble');
                        bubble.innerHTML = `<img src="${message.content}" class="chat-image" onclick="openImageViewer(this)">`;
                    } else {
                        bubble.textContent = message.content;
                    }
                    if (timeString) bubble.innerHTML += `<span class="message-time">${timeString}</span>`;
                    
                    // Hi·ªÉn th·ªã reactions n·∫øu c√≥
                    renderReactionsOnBubble(bubble, message.reactions);

                    contentContainer.append(avatar, bubble);
                    
                    // Th√™m n√∫t Actions SAU bong b√≥ng chat
                    if (message.type !== 'REVOKED') addMessageOptions(contentContainer, message, false);
                }
                messageLi.appendChild(contentContainer);
            }
            messageArea.appendChild(messageLi);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // --- X·ª¨ L√ù MESSAGE ACTIONS (3 CH·∫§M + REACTION) ---
        function addMessageOptions(container, message, isMyMessage) {
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'msg-actions-container';

            // 1. N√∫t M·∫∑t c∆∞·ªùi (Reaction)
            const reactBtn = document.createElement('div');
            reactBtn.className = 'reaction-btn';
            reactBtn.innerHTML = '‚ò∫'; // Ho·∫∑c d√πng icon SVG
            
            // Thanh c·∫£m x√∫c (Reaction Bar)
            const reactionBar = document.createElement('div');
            reactionBar.className = 'reaction-bar';
            const emojis = ['üëç', '‚ù§Ô∏è', 'üòÜ', 'üòÆ', 'üò¢', 'üò†'];
            
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'reaction-emoji';
                span.textContent = emoji;
                span.onclick = (e) => {
                    e.stopPropagation();
                    sendReaction(message, emoji);
                    reactionBar.classList.remove('show');
                };
                reactionBar.appendChild(span);
            });

            reactBtn.onclick = (e) => {
                e.stopPropagation();
                // ƒê√≥ng c√°c reaction bar kh√°c
                document.querySelectorAll('.reaction-bar').forEach(b => b.classList.remove('show'));
                document.querySelectorAll('.msg-dropdown').forEach(d => d.classList.remove('show'));
                
                reactionBar.classList.toggle('show');
            };
            
            reactBtn.appendChild(reactionBar);
            actionsContainer.appendChild(reactBtn);

            // 2. N√∫t 3 ch·∫•m (Options)
            const btn = document.createElement('div');
            btn.className = 'msg-options-btn';
            btn.innerHTML = '‚Ä¢‚Ä¢‚Ä¢';
            
            // T·∫°o dropdown menu
            const dropdown = document.createElement('div');
            dropdown.className = 'msg-dropdown';
            dropdown.id = `msg-dropdown-${message.id}`;
            
            const removeOption = document.createElement('div');
            removeOption.className = 'msg-dropdown-item danger';
            removeOption.textContent = isMyMessage ? 'Thu h·ªìi' : 'G·ª°';
            removeOption.onclick = (e) => {
                e.stopPropagation();
                openRemoveMsgModal(message, isMyMessage);
                dropdown.classList.remove('show');
            };
            
            dropdown.appendChild(removeOption);
            
            // X·ª≠ l√Ω click n√∫t 3 ch·∫•m
            btn.onclick = (e) => {
                e.stopPropagation();
                // ƒê√≥ng t·∫•t c·∫£ dropdown kh√°c
                document.querySelectorAll('.msg-dropdown').forEach(d => d.classList.remove('show'));
                document.querySelectorAll('.reaction-bar').forEach(b => b.classList.remove('show'));
                
                // Hi·ªÉn th·ªã dropdown n√†y
                dropdown.classList.toggle('show');
                
                // ƒê·ªãnh v·ªã dropdown
                dropdown.style.top = '25px';
                if (isMyMessage) {
                    dropdown.style.right = '30px'; // Hi·ªán b√™n tr√°i n√∫t
                } else {
                    dropdown.style.right = '0'; // Hi·ªán b√™n tr√°i n√∫t (ƒë·ªÉ kh√¥ng b·ªã khu·∫•t)
                }
            };

            // ƒê√≥ng dropdown khi chu·ªôt r·ªùi kh·ªèi v√πng tin nh·∫Øn
            let timeoutId;
            container.addEventListener('mouseleave', () => {
                timeoutId = setTimeout(() => {
                    dropdown.classList.remove('show');
                    reactionBar.classList.remove('show');
                }, 500); // Th√™m ƒë·ªô tr·ªÖ 0.5s ƒë·ªÉ ng∆∞·ªùi d√πng k·ªãp thao t√°c
            });
            container.addEventListener('mouseenter', () => {
                if (timeoutId) clearTimeout(timeoutId);
            });

            actionsContainer.appendChild(btn);
            btn.appendChild(dropdown); // G·∫Øn dropdown v√†o trong n√∫t ƒë·ªÉ d·ªÖ ƒë·ªãnh v·ªã
            
            container.appendChild(actionsContainer);
        }

        function sendReaction(message, emoji) {
            if (stompClient) {
                stompClient.send("/app/chat.react", {}, JSON.stringify({
                    id: message.id,
                    roomId: message.roomId,
                    sender: username, // Ng∆∞·ªùi th·∫£ c·∫£m x√∫c
                    content: emoji // Emoji ƒë∆∞·ª£c th·∫£
                }));
            }
        }

        function renderReactionsOnBubble(bubble, reactionsJson) {
            // X√≥a hi·ªÉn th·ªã c≈© n·∫øu c√≥
            const oldDisplay = bubble.querySelector('.message-reactions-display');
            if (oldDisplay) oldDisplay.remove();

            if (!reactionsJson) return;

            try {
                const reactions = JSON.parse(reactionsJson);
                const counts = {};
                let total = 0;
                
                Object.values(reactions).forEach(emoji => {
                    counts[emoji] = (counts[emoji] || 0) + 1;
                    total++;
                });

                if (total > 0) {
                    const display = document.createElement('div');
                    display.className = 'message-reactions-display';
                    
                    // Hi·ªÉn th·ªã t·ªëi ƒëa 3 lo·∫°i emoji ph·ªï bi·∫øn nh·∫•t
                    const sortedEmojis = Object.keys(counts).sort((a, b) => counts[b] - counts[a]).slice(0, 3);
                    
                    let html = sortedEmojis.map(e => `<span>${e}</span>`).join('');
                    if (total > 1) html += `<span style="margin-left:2px; color:#65676b; font-weight:bold">${total}</span>`;
                    
                    display.innerHTML = html;
                    bubble.appendChild(display);
                }
            } catch (e) {
                console.error("L·ªói parse reactions", e);
            }
        }

        // ƒê√≥ng dropdown tin nh·∫Øn khi click ra ngo√†i
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.msg-options-btn') && !e.target.closest('.reaction-btn')) {
                document.querySelectorAll('.msg-dropdown').forEach(d => d.classList.remove('show'));
                document.querySelectorAll('.reaction-bar').forEach(b => b.classList.remove('show'));
            }
        });

        // --- MODAL G·ª† TIN NH·∫ÆN ---
        function openRemoveMsgModal(message, isMyMessage) {
            selectedMessageId = message.id;
            const modal = document.getElementById('remove-msg-modal');
            const title = document.getElementById('remove-msg-title');
            const desc = document.getElementById('remove-msg-desc');
            const actionsDiv = document.getElementById('remove-msg-actions');
            actionsDiv.innerHTML = '';

            // N·∫øu l√† tin nh·∫Øn c·ªßa m√¨nh -> C√≥ quy·ªÅn Thu h·ªìi
            if (isMyMessage) {
                title.textContent = "B·∫°n mu·ªën g·ª° tin nh·∫Øn n√†y?";
                desc.textContent = "Tin nh·∫Øn s·∫Ω b·ªã g·ª° kh·ªèi ƒëo·∫°n chat.";

                const unsendBtn = document.createElement('div');
                unsendBtn.className = 'remove-option-btn danger';
                unsendBtn.innerHTML = '<b>Thu h·ªìi v·ªõi m·ªçi ng∆∞·ªùi</b><br><span style="font-size:11px; font-weight:normal">Tin nh·∫Øn s·∫Ω b·ªã thu h·ªìi ph√≠a m·ªçi ng∆∞·ªùi.</span>';
                unsendBtn.onclick = () => {
                    if (stompClient) {
                        stompClient.send("/app/chat.revoke", {}, JSON.stringify(message));
                    }
                    closeRemoveMsgModal();
                };
                actionsDiv.appendChild(unsendBtn);

                // T√πy ch·ªçn X√≥a ·ªü ph√≠a b·∫°n (cho ng∆∞·ªùi g·ª≠i)
                const deleteForMeBtn = document.createElement('div');
                deleteForMeBtn.className = 'remove-option-btn';
                deleteForMeBtn.innerHTML = '<b>Thu h·ªìi v·ªõi b·∫°n</b><br><span style="font-size:11px; font-weight:normal; color:#65676b">G·ª° tin nh·∫Øn n√†y kh·ªèi danh s√°ch c·ªßa b·∫°n.</span>';
                deleteForMeBtn.onclick = () => deleteMessageForMe(message);
                actionsDiv.appendChild(deleteForMeBtn);
            } else {
                // N·∫øu l√† tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c -> Ch·ªâ c√≥ G·ª°
                title.textContent = "G·ª° ·ªü ph√≠a b·∫°n";
                desc.textContent = "Tin nh·∫Øn n√†y s·∫Ω b·ªã g·ª° kh·ªèi thi·∫øt b·ªã c·ªßa b·∫°n, nh∆∞ng v·∫´n hi·ªÉn th·ªã v·ªõi c√°c th√†nh vi√™n kh√°c trong ƒëo·∫°n chat.";

                const btnContainer = document.createElement('div');
                btnContainer.style.display = 'flex';
                btnContainer.style.justifyContent = 'flex-end';
                btnContainer.style.gap = '10px';
                btnContainer.style.marginTop = '10px';

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn-cancel';
                cancelBtn.textContent = 'H·ªßy';
                cancelBtn.onclick = closeRemoveMsgModal;

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-save';
                confirmBtn.textContent = 'G·ª°';
                confirmBtn.onclick = () => deleteMessageForMe(message);

                btnContainer.appendChild(cancelBtn);
                btnContainer.appendChild(confirmBtn);
                actionsDiv.appendChild(btnContainer);
            }

            modal.classList.remove('hidden');
        }

        function deleteMessageForMe(message) {
            fetch(`/api/messages/single/${message.id}?username=${username}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        // X√≥a tin nh·∫Øn kh·ªèi giao di·ªán ngay l·∫≠p t·ª©c
                        const msgEl = document.getElementById(`msg-${message.id}`);
                        if (msgEl) {
                            msgEl.remove();
                        }
                    }
                });
            closeRemoveMsgModal();
        }

        function closeRemoveMsgModal() {
            document.getElementById('remove-msg-modal').classList.add('hidden');
            selectedMessageId = null;
        }

        function addDateSeparator(timestamp, partnerUsername) {
            var messageArea = document.querySelector(`#msg-area-${partnerUsername}`);
            if (!messageArea) return;
            
            var li = document.createElement('li');
            li.className = 'date-separator';
            li.textContent = formatFullDate(timestamp);
            messageArea.appendChild(li);
        }

        function addSeenIcon(container, partnerUsername) {
            var displayName = getDisplayName(partnerUsername);
            const icon = document.createElement('div');
            icon.className = 'seen-icon';
            icon.style.backgroundColor = getAvatarColor(displayName);
            icon.textContent = displayName.charAt(0);
            container.appendChild(icon);
        }

        function sendReadReceipt(partnerUsername, roomId) {
            if(stompClient && activeChats[partnerUsername]) {
                stompClient.send("/app/chat.read", {}, JSON.stringify({
                    sender: username, // T√¥i l√† ng∆∞·ªùi ƒë·ªçc
                    type: 'READ',
                    roomId: roomId
                }));
            }
        }

        // --- LOGIC ƒêANG SO·∫†N TIN (TYPING) ---
        var lastTypingTime = 0;
        function handleTyping(partnerUsername) {
            const now = Date.now();
            // Ch·ªâ g·ª≠i s·ª± ki·ªán m·ªói 2 gi√¢y ƒë·ªÉ tr√°nh spam server
            if (now - lastTypingTime > 2000 && stompClient && activeChats[partnerUsername]) {
                const roomId = activeChats[partnerUsername].roomId;
                stompClient.send("/app/chat.typing", {}, JSON.stringify({
                    sender: username,
                    type: 'TYPING',
                    roomId: roomId
                }));
                lastTypingTime = now;
            }
        }

        function showTypingIndicator(partnerUsername, senderUsername) {
            const indicator = document.getElementById(`typing-${partnerUsername}`);
            if (!indicator) return;

            // L·∫•y t√™n hi·ªÉn th·ªã th·ª±c t·∫ø t·ª´ username, sau ƒë√≥ m·ªõi l·∫•y t√™n cu·ªëi
            const displayName = getDisplayName(senderUsername);
            const nameParts = displayName.trim().split(/\s+/);
            const lastName = nameParts[nameParts.length - 1];

            indicator.textContent = `... ${lastName} ƒëang so·∫°n tin nh·∫Øn`;
            indicator.classList.add('visible');

            // X√≥a timeout c≈© v√† ƒë·∫∑t timeout m·ªõi ƒë·ªÉ ·∫©n th√¥ng b√°o sau 3 gi√¢y
            if (activeChats[partnerUsername].typingTimeout) clearTimeout(activeChats[partnerUsername].typingTimeout);
            activeChats[partnerUsername].typingTimeout = setTimeout(() => {
                indicator.classList.remove('visible');
            }, 3000);
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto'; // Reset ƒë·ªÉ t√≠nh to√°n l·∫°i
            textarea.style.height = textarea.scrollHeight + 'px'; // G√°n chi·ªÅu cao theo n·ªôi dung
        }

        function handleEnter(event, partnerUsername) {
            // N·∫øu nh·∫•n Enter m√† kh√¥ng gi·ªØ Shift -> G·ª≠i tin nh·∫Øn
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event, partnerUsername);
            }
        }

        // --- X·ª¨ L√ù ·∫¢NH ---
        function handleFileSelect(event, partnerUsername) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                
                // Hi·ªÉn th·ªã preview
                const previewContainer = document.getElementById(`preview-container-${partnerUsername}`);
                const previewImg = document.getElementById(`preview-img-${partnerUsername}`);
                
                previewImg.src = base64Image;
                previewContainer.style.display = 'block';
                
                // L∆∞u v√†o bi·∫øn t·∫°m ƒë·ªÉ ch·ªù g·ª≠i
                if (activeChats[partnerUsername]) {
                    activeChats[partnerUsername].pendingImage = base64Image;
                }
            };
            reader.readAsDataURL(file);
            event.target.value = ''; // Reset input ƒë·ªÉ ch·ªçn l·∫°i c√πng file n·∫øu mu·ªën
        }

        function removeImage(partnerUsername) {
            document.getElementById(`preview-container-${partnerUsername}`).style.display = 'none';
            if (activeChats[partnerUsername]) activeChats[partnerUsername].pendingImage = null;
        }

        function sendMessage(event, partnerUsername) {
            if(event.preventDefault) event.preventDefault(); // NgƒÉn reload trang
            
            // T√¨m input trong form v·ª´a submit
            var form = event.target.tagName === 'FORM' ? event.target : event.target.closest('form');
            var input = form.querySelector('textarea');
            var content = input.value.trim();
            
            // Ki·ªÉm tra xem c√≥ tin nh·∫Øn text ho·∫∑c ·∫£nh kh√¥ng
            const hasImage = activeChats[partnerUsername] && activeChats[partnerUsername].pendingImage;
            
            if((content || hasImage) && stompClient && activeChats[partnerUsername]) {
                const roomId = activeChats[partnerUsername].roomId;
                
                // N·∫øu c√≥ ·∫£nh, g·ª≠i ·∫£nh tr∆∞·ªõc (ho·∫∑c g·ª≠i text n·∫øu kh√¥ng c√≥ ·∫£nh)
                if (hasImage) {
                    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                        sender: username, content: activeChats[partnerUsername].pendingImage, type: 'IMAGE', roomId: roomId
                    }));
                    removeImage(partnerUsername); // X√≥a preview sau khi g·ª≠i
                }

                // N·∫øu c√≥ text, g·ª≠i text
                if (content) {
                    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                        sender: username, content: content, type: 'CHAT', roomId: roomId
                    }));
                }
                
                input.value = '';
                input.style.height = 'auto'; // Reset chi·ªÅu cao v·ªÅ 1 d√≤ng
            }
        }

        // --- H√ÄM X·ª¨ L√ù TR·∫†NG TH√ÅI & TH·ªúI GIAN ---
        function updateStatusUI(username, status, lastActive) {
            const statusEl = document.getElementById(`status-${username}`);
            if (!statusEl) return;

            // C·∫≠p nh·∫≠t badge tr√™n header
            const badgeEl = document.getElementById(`header-status-${username}`);
            if (badgeEl) {
                badgeEl.className = 'status-badge header-status-badge';
                if (status === 'ONLINE') {
                    badgeEl.classList.add('status-online');
                    badgeEl.classList.remove('hidden');
                    badgeEl.textContent = '';
                } else {
                    badgeEl.classList.add('hidden');
                    badgeEl.textContent = '';
                }
            }

            // C·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o activeChats ƒë·ªÉ setInterval c√≥ th·ªÉ d√πng l·∫°i
            if (activeChats[username]) {
                activeChats[username].status = status;
                activeChats[username].lastActive = lastActive;
            }

            if (status === 'ONLINE') {
                statusEl.textContent = 'ƒêang ho·∫°t ƒë·ªông';
            } else {
                statusEl.textContent = 'Ho·∫°t ƒë·ªông ' + timeSince(lastActive);
            }
        }

        function parseDate(date) {
            if (!date) return null;
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p Java g·ª≠i v·ªÅ m·∫£ng [yyyy, MM, dd, HH, mm, ss]
            if (Array.isArray(date)) {
                return new Date(date[0], date[1] - 1, date[2], date[3], date[4], date[5]);
            }
            return new Date(date);
        }

        function formatTime(date) {
            var d = parseDate(date);
            if (!d) return "";
            var hours = d.getHours().toString().padStart(2, '0');
            var minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatFullDate(date) {
            var d = parseDate(date);
            if (!d) d = new Date(); // Fallback n·∫øu kh√¥ng c√≥ time
            
            var now = new Date();
            var hours = d.getHours().toString().padStart(2, '0');
            var minutes = d.getMinutes().toString().padStart(2, '0');
            
            // So s√°nh ng√†y (b·ªè qua gi·ªù ph√∫t gi√¢y ƒë·ªÉ t√≠nh kho·∫£ng c√°ch ng√†y ch√≠nh x√°c)
            var dZero = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            var nowZero = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var diffTime = nowZero - dZero;
            var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return `${hours}:${minutes}`;
            } else if (diffDays > 0 && diffDays < 7) {
                var days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
                return `${hours}:${minutes} ${days[d.getDay()]}`;
            } else {
                var day = d.getDate().toString().padStart(2, '0');
                var month = (d.getMonth() + 1).toString().padStart(2, '0');
                var year = d.getFullYear();
                return `${hours}:${minutes} ${day} th√°ng ${month}, ${year}`;
            }
        }

        function timeSince(date) {
            date = parseDate(date);
            if (!date) return "v√†i ph√∫t tr∆∞·ªõc";
            var seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return "1 ph√∫t tr∆∞·ªõc"; // Hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
            
            var interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " nƒÉm tr∆∞·ªõc";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " th√°ng tr∆∞·ªõc";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ng√†y tr∆∞·ªõc";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " gi·ªù tr∆∞·ªõc";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " ph√∫t tr∆∞·ªõc";
            return "V·ª´a xong";
        }

        function getShortTime(date) {
            date = parseDate(date);
            if (!date) return "";
            var seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return "1p";
            var minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + "p";
            var hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + "h";
            var days = Math.floor(hours / 24);
            return days + "d";
        }

        // --- TR√åNH XEM ·∫¢NH ---
        var currentImageList = []; // L∆∞u danh s√°ch ·∫£nh hi·ªán t·∫°i
        var currentImageIndex = 0;
        var currentZoom = 1; // Bi·∫øn l∆∞u t·ª∑ l·ªá zoom hi·ªán t·∫°i
        var currentTranslateX = 0;
        var currentTranslateY = 0;

        function openImageViewer(imgElement) {
            const overlay = document.getElementById('image-viewer-overlay');
            const img = document.getElementById('image-viewer-img');
            const thumbnailsContainer = document.getElementById('image-viewer-thumbnails');
            
            // 1. T√¨m c·ª≠a s·ªï chat ch·ª©a ·∫£nh n√†y ƒë·ªÉ l·∫•y t·∫•t c·∫£ ·∫£nh trong ƒë√≥
            const chatBody = imgElement.closest('.chat-window-body');
            if (chatBody) {
                // L·∫•y t·∫•t c·∫£ th·∫ª img c√≥ class chat-image trong c·ª≠a s·ªï n√†y
                const images = chatBody.querySelectorAll('.chat-image');
                currentImageList = Array.from(images).map(i => i.src);
                currentImageIndex = currentImageList.indexOf(imgElement.src);
            } else {
                // Fallback n·∫øu kh√¥ng t√¨m th·∫•y context (hi·∫øm khi x·∫£y ra)
                currentImageList = [imgElement.src];
                currentImageIndex = 0;
            }

            // 2. Hi·ªÉn th·ªã ·∫£nh ch√≠nh
            updateImageViewerDisplay();
            overlay.classList.add('active');
        }

        function updateImageViewerDisplay() {
            const img = document.getElementById('image-viewer-img');
            const thumbnailsContainer = document.getElementById('image-viewer-thumbnails');
            
            // C·∫≠p nh·∫≠t ·∫£nh l·ªõn
            img.src = currentImageList[currentImageIndex];
            
            // Reset zoom v·ªÅ m·∫∑c ƒë·ªãnh khi ƒë·ªïi ·∫£nh
            currentZoom = 1;
            currentTranslateX = 0;
            currentTranslateY = 0;
            img.style.transform = 'translate(0px, 0px) scale(1)';
            img.style.cursor = 'default';

            // T·∫°o danh s√°ch thumbnail
            thumbnailsContainer.innerHTML = '';
            currentImageList.forEach((src, index) => {
                const thumb = document.createElement('img');
                thumb.src = src;
                thumb.className = `viewer-thumb ${index === currentImageIndex ? 'active' : ''}`;
                thumb.draggable = false; // NgƒÉn tr√¨nh duy·ªát t·ª± ƒë·ªông k√©o ·∫£nh (native drag)
                thumb.onclick = () => {
                    currentImageIndex = index;
                    updateImageViewerDisplay();
                };
                thumbnailsContainer.appendChild(thumb);
            });
            
            // T·ª± ƒë·ªông cu·ªôn thumbnail active v√†o gi·ªØa
            setTimeout(() => {
                const activeThumb = thumbnailsContainer.querySelector('.active');
                if (activeThumb) {
                    activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, 10);
        }

        function closeImageViewer() {
            const overlay = document.getElementById('image-viewer-overlay');
            overlay.classList.remove('active');
            setTimeout(() => {
                document.getElementById('image-viewer-img').src = '';
            }, 300); // X√≥a src sau khi hi·ªáu ·ª©ng m·ªù k·∫øt th√∫c
        }
        
        // ƒê√≥ng b·∫±ng ph√≠m ESC
        document.addEventListener('keydown', function(event) {
            const overlay = document.getElementById('image-viewer-overlay');
            if (overlay.classList.contains('active')) {
                if (event.key === "Escape") closeImageViewer();
                // H·ªó tr·ª£ ph√≠m m≈©i t√™n tr√°i/ph·∫£i ƒë·ªÉ chuy·ªÉn ·∫£nh
                if (event.key === "ArrowLeft") {
                    if (currentImageIndex > 0) {
                        currentImageIndex--;
                        updateImageViewerDisplay();
                    }
                }
                if (event.key === "ArrowRight") {
                    if (currentImageIndex < currentImageList.length - 1) {
                        currentImageIndex++;
                        updateImageViewerDisplay();
                    }
                }
            }
        });

        // --- ZOOM ·∫¢NH B·∫∞NG CON LƒÇN CHU·ªòT ---
        const imgViewer = document.getElementById('image-viewer-img');
        imgViewer.addEventListener('wheel', function(e) {
            e.preventDefault(); // NgƒÉn cu·ªôn trang web
            
            // T√≠nh to√°n t·ª∑ l·ªá zoom m·ªõi (deltaY √¢m l√† lƒÉn l√™n/ph√≥ng to)
            const delta = e.deltaY * -0.001; 
            currentZoom = Math.min(Math.max(0.5, currentZoom + delta), 5); // Gi·ªõi h·∫°n t·ª´ 0.5x ƒë·∫øn 5x
            
            if (currentZoom <= 1) {
                currentZoom = 1;
                currentTranslateX = 0;
                currentTranslateY = 0;
                this.style.cursor = 'default';
            } else {
                this.style.cursor = 'grab';
            }
            
            this.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`;
        });

        // --- K√âO ·∫¢NH (PAN) KHI ƒêANG ZOOM ---
        let isDraggingImage = false;
        let imgStartX = 0, imgStartY = 0;

        imgViewer.addEventListener('mousedown', function(e) {
            if (currentZoom <= 1) return; // Ch·ªâ cho ph√©p k√©o khi ƒë√£ ph√≥ng to
            isDraggingImage = true;
            imgStartX = e.clientX - currentTranslateX;
            imgStartY = e.clientY - currentTranslateY;
            this.classList.add('dragging');
            e.preventDefault();
        });

        window.addEventListener('mouseup', function() {
            if (isDraggingImage) {
                isDraggingImage = false;
                imgViewer.classList.remove('dragging');

                // --- T√çNH TO√ÅN GI·ªöI H·∫†N ƒê·ªÇ ƒê·∫®Y ·∫¢NH V·ªÄ (SNAP BACK) ---
                const overlay = document.getElementById('image-viewer-overlay');
                const viewWidth = overlay.clientWidth;
                const viewHeight = overlay.clientHeight;

                // K√≠ch th∆∞·ªõc hi·ªán t·∫°i c·ªßa ·∫£nh sau khi zoom
                const renderedWidth = imgViewer.offsetWidth * currentZoom;
                const renderedHeight = imgViewer.offsetHeight * currentZoom;

                // T√≠nh to√°n gi·ªõi h·∫°n di chuy·ªÉn (Limit)
                // N·∫øu ·∫£nh to h∆°n m√†n h√¨nh: gi·ªõi h·∫°n l√† kho·∫£ng c√°ch t·ª´ t√¢m ƒë·ªÉ m√©p ·∫£nh ch·∫°m m√©p m√†n h√¨nh
                // N·∫øu ·∫£nh nh·ªè h∆°n m√†n h√¨nh: gi·ªõi h·∫°n l√† 0 (ph·∫£i ·ªü gi·ªØa)
                const limitX = renderedWidth > viewWidth ? (renderedWidth - viewWidth) / 2 : 0;
                const limitY = renderedHeight > viewHeight ? (renderedHeight - viewHeight) / 2 : 0;

                let newX = currentTranslateX;
                let newY = currentTranslateY;

                // Ki·ªÉm tra v√† ƒëi·ªÅu ch·ªânh X (N·∫øu v∆∞·ª£t qu√° gi·ªõi h·∫°n th√¨ g√°n l·∫°i b·∫±ng gi·ªõi h·∫°n)
                if (currentTranslateX > limitX) newX = limitX;
                else if (currentTranslateX < -limitX) newX = -limitX;

                // Ki·ªÉm tra v√† ƒëi·ªÅu ch·ªânh Y
                if (currentTranslateY > limitY) newY = limitY;
                else if (currentTranslateY < -limitY) newY = -limitY;

                // N·∫øu v·ªã tr√≠ c·∫ßn thay ƒë·ªïi, th·ª±c hi·ªán animation tr∆∞·ª£t v·ªÅ
                if (newX !== currentTranslateX || newY !== currentTranslateY) {
                    currentTranslateX = newX;
                    currentTranslateY = newY;
                    
                    // Th√™m transition t·∫°m th·ªùi ƒë·ªÉ hi·ªáu ·ª©ng tr∆∞·ª£t v·ªÅ m∆∞·ª£t m√† (0.3s)
                    imgViewer.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
                    imgViewer.style.transform = `translate(${newX}px, ${newY}px) scale(${currentZoom})`;

                    // Reset transition v·ªÅ m·∫∑c ƒë·ªãnh (trong CSS) sau khi animation xong
                    setTimeout(() => {
                        imgViewer.style.transition = ''; 
                    }, 300);
                }
            }
        });

        window.addEventListener('mousemove', function(e) {
            if (!isDraggingImage) return;
            e.preventDefault();
            currentTranslateX = e.clientX - imgStartX;
            currentTranslateY = e.clientY - imgStartY;
            imgViewer.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`;
        });

        // --- K√âO ƒê·ªÇ CU·ªòN (DRAG TO SCROLL) CHO THUMBNAILS ---
        const slider = document.getElementById('image-viewer-thumbnails');
        let isDown = false;
        let startX;
        let scrollLeft;

        slider.addEventListener('mousedown', (e) => {
            isDown = true;
            slider.classList.add('grabbing');
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
            e.preventDefault(); // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh (b√¥i ƒëen, k√©o ·∫£nh) ƒë·ªÉ tr√°nh l·ªói d√≠nh chu·ªôt
        });

        slider.addEventListener('mouseleave', () => {
            isDown = false;
            slider.classList.remove('grabbing');
        });

        slider.addEventListener('mouseup', () => {
            isDown = false;
            slider.classList.remove('grabbing');
        });

        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 2; // T·ªëc ƒë·ªô cu·ªôn (nh√¢n 2 ƒë·ªÉ nhanh h∆°n)
            slider.scrollLeft = scrollLeft - walk;
        });

        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t th·ªùi gian "Ho·∫°t ƒë·ªông X ph√∫t tr∆∞·ªõc" m·ªói ph√∫t
        setInterval(() => {
            Object.keys(activeChats).forEach(username => {
                const chat = activeChats[username];
                if (chat.status !== 'ONLINE') {
                    updateStatusUI(username, chat.status, chat.lastActive);
                }
            });
            // C·∫≠p nh·∫≠t danh s√°ch user (n·∫øu ƒëang hi·ªÉn th·ªã) ƒë·ªÉ update th·ªùi gian offline (v√≠ d·ª• 1p -> 2p)
            if (!document.querySelector('#user-list-page').classList.contains('hidden')) {
                renderUserList();
            }
        }, 60000);

        // --- LOGIC C·∫ÆT ·∫¢NH (CROP) ---
        let cropScale = 1;
        let cropX = 0, cropY = 0;
        let isDraggingCrop = false;
        let cropStartX = 0, cropStartY = 0;
        let initialCropX = 0, initialCropY = 0;
        let cropMinScale = 0.1;
        let cropMaxScale = 5;

        function openCropModal(imageSrc) {
                const img = document.getElementById('crop-image');
                img.src = imageSrc;
                img.onload = () => {
                    // T√≠nh to√°n scale ban ƒë·∫ßu ƒë·ªÉ ·∫£nh v·ª´a kh√≠t v√≤ng tr√≤n 300px
                    // V√≤ng tr√≤n mask ƒë∆∞·ªùng k√≠nh 300px (radius 150px)
                    const minDimension = Math.min(img.naturalWidth, img.naturalHeight);
                    const initialScale = 300 / minDimension;
                    
                    cropScale = initialScale;
                    cropX = 0; cropY = 0;
                    
                    cropMinScale = initialScale; // Kh√¥ng cho ph√©p zoom nh·ªè h∆°n khung h√¨nh
                    cropMaxScale = initialScale * 5;
                    
                    updateCropTransform();
                    document.getElementById('crop-avatar-modal').classList.add('active');
                };
        }

        function closeCropModal() {
            document.getElementById('crop-avatar-modal').classList.remove('active');
        }

        function updateCropTransform() {
            const img = document.getElementById('crop-image');
            img.style.transform = `translate(${cropX}px, ${cropY}px) scale(${cropScale})`;
        }

        // Zoom b·∫±ng con lƒÉn chu·ªôt
        document.getElementById('crop-body').addEventListener('wheel', function(e) {
            e.preventDefault();
            const delta = e.deltaY * -0.001;
            const newScale = Math.min(Math.max(cropMinScale, cropScale + delta), cropMaxScale);
            cropScale = newScale;

            // --- T√çNH TO√ÅN GI·ªöI H·∫†N ƒê·ªÇ GI·ªÆ ·∫¢NH TRONG KHUNG KHI ZOOM ---
            const img = document.getElementById('crop-image');
            const R = 150; 
            const currentWidth = img.naturalWidth * cropScale;
            const currentHeight = img.naturalHeight * cropScale;
            
            let limitX = (currentWidth / 2) - R;
            let limitY = (currentHeight / 2) - R;
            
            if (limitX < 0) limitX = 0;
            if (limitY < 0) limitY = 0;
            
            // Clamp (K·∫πp) v·ªã tr√≠ ƒë·ªÉ kh√¥ng b·ªã l·ªách ra ngo√†i
            if (cropX > limitX) cropX = limitX;
            else if (cropX < -limitX) cropX = -limitX;
            
            if (cropY > limitY) cropY = limitY;
            else if (cropY < -limitY) cropY = -limitY;

            updateCropTransform();
        });

        // Dragging Logic
        const cropBody = document.getElementById('crop-body');
        cropBody.addEventListener('mousedown', function(e) {
            isDraggingCrop = true;
            cropStartX = e.clientX;
            cropStartY = e.clientY;
            initialCropX = cropX;
            initialCropY = cropY;
            e.preventDefault();
        });

        window.addEventListener('mousemove', function(e) {
            if (!isDraggingCrop) return;
            e.preventDefault();
            const dx = e.clientX - cropStartX;
            const dy = e.clientY - cropStartY;
            cropX = initialCropX + dx;
            cropY = initialCropY + dy;
            updateCropTransform();
        });

        window.addEventListener('mouseup', function() {
            if (isDraggingCrop) {
                isDraggingCrop = false;
                
                // --- SNAP BACK LOGIC (T·ª± ƒë·ªông ƒë√†n h·ªìi v·ªÅ v·ªã tr√≠ h·ª£p l√Ω) ---
                const img = document.getElementById('crop-image');
                const R = 150; // B√°n k√≠nh v√≤ng tr√≤n crop (300px / 2)
                
                const currentWidth = img.naturalWidth * cropScale;
                const currentHeight = img.naturalHeight * cropScale;
                
                // T√≠nh to√°n gi·ªõi h·∫°n di chuy·ªÉn
                // Max X = (Width/2) - R. N·∫øu k√©o qu√° gi·ªõi h·∫°n n√†y, m√©p ·∫£nh s·∫Ω h·ªü ra v√πng ƒëen.
                let limitX = (currentWidth / 2) - R;
                let limitY = (currentHeight / 2) - R;
                
                // N·∫øu ·∫£nh nh·ªè h∆°n v√πng crop (do zoom nh·ªè), snap v·ªÅ gi·ªØa (0)
                if (limitX < 0) limitX = 0;
                if (limitY < 0) limitY = 0;
                
                let newX = cropX;
                let newY = cropY;
                
                if (cropX > limitX) newX = limitX;
                else if (cropX < -limitX) newX = -limitX;
                
                if (cropY > limitY) newY = limitY;
                else if (cropY < -limitY) newY = -limitY;
                
                if (newX !== cropX || newY !== cropY) {
                    cropX = newX;
                    cropY = newY;
                    img.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
                    updateCropTransform();
                    setTimeout(() => { img.style.transition = ''; }, 300);
                }
            }
        });

        function saveCrop() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = document.getElementById('crop-image');
            
            // K√≠ch th∆∞·ªõc ƒë·∫ßu ra (300x300)
            canvas.width = 300; canvas.height = 300;
            ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, 300, 300);
            
            // V·∫Ω ·∫£nh ƒë√£ transform v√†o canvas
            // D·ªãch chuy·ªÉn canvas v·ªÅ t√¢m (150,150) -> √°p d·ª•ng transform c·ªßa ·∫£nh -> v·∫Ω ·∫£nh centered
            ctx.translate(150, 150);
            ctx.translate(cropX, cropY);
            ctx.scale(cropScale, cropScale);
            ctx.drawImage(img, -img.naturalWidth / 2, -img.naturalHeight / 2);
            
            const base64 = canvas.toDataURL('image/jpeg', 0.9);
            
            // C·∫≠p nh·∫≠t preview
            const preview = document.getElementById('edit-avatar-preview');
            preview.style.backgroundImage = `url(${base64})`;
            preview.textContent = '';
            preview.dataset.newAvatar = base64;
            
            closeCropModal();
        }
    </script>
</body>
</html>