<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App - Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Nút đăng xuất toàn cục -->
    <button onclick="logout()" id="logout-btn" class="logout-btn hidden">Đăng xuất</button>

    <div id="username-page">
        <div class="username-page-container">
            <div id="login-section">
                <h1 class="title">Đăng nhập</h1>
                <input type="text" id="login-username" placeholder="Tài khoản" autocomplete="off" />
                <input type="password" id="login-password" placeholder="Mật khẩu" />
                <button onclick="login()" class="accent username-submit">Đăng nhập</button>
                <p class="toggle-text">Chưa có tài khoản? <span onclick="showRegister()">Đăng ký ngay</span></p>
            </div>

            <div id="register-section" class="hidden">
                <h1 class="title">Đăng ký tài khoản</h1>
                <input type="text" id="reg-username" placeholder="Tên đăng nhập mới" autocomplete="off" />
                <input type="password" id="reg-password" placeholder="Mật khẩu mới" />
                <input type="text" id="reg-displayname" placeholder="Tên hiển thị (Tùy chọn)" autocomplete="off" />
                <button onclick="register()" class="accent username-submit" style="background-color: #0084ff;">Tạo tài khoản</button>
                <p class="toggle-text">Đã có tài khoản? <span onclick="showLogin()">Quay lại Đăng nhập</span></p>
            </div>
        </div>
    </div>

    <!-- Màn hình danh sách người dùng -->
    <div id="user-list-page" class="hidden">
        <h2 class="title" style="margin-bottom: 20px;">Chọn người để chat</h2>
        <div id="user-grid" class="user-grid">
            <!-- Các icon user sẽ được thêm vào đây bằng JS -->
        </div>
    </div>

    <script>
        var stompClient = null;
        var username = null; 
        var activeChats = {}; // Lưu trữ các cửa sổ chat đang mở: { 'username': { element, subscription, roomId } }
        var allUsers = []; // Danh sách user

        // CHUYỂN ĐỔI GIAO DIỆN
        function showRegister() {
            document.querySelector('#login-section').classList.add('hidden');
            document.querySelector('#register-section').classList.remove('hidden');
        }

        function showLogin() {
            document.querySelector('#register-section').classList.add('hidden');
            document.querySelector('#login-section').classList.remove('hidden');
        }

        // ĐĂNG KÝ & ĐĂNG NHẬP
        function register() {
            const u = document.querySelector('#reg-username').value.trim();
            const p = document.querySelector('#reg-password').value.trim();
            const dn = document.querySelector('#reg-displayname').value.trim();
            if(!u || !p) { alert("Vui lòng nhập đủ tài khoản và mật khẩu"); return; }

            fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p, displayName: dn})
            }).then(res => res.text()).then(data => {
                alert(data);
                if(data === "Đăng ký thành công!") showLogin();
            });
        }

        function login() {
            const u = document.querySelector('#login-username').value.trim();
            const p = document.querySelector('#login-password').value.trim();

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            }).then(res => {
                if(res.ok) {
                    return res.json(); // Chuyển đổi phản hồi từ server sang JSON
                } else { throw new Error("Login failed"); }
            }).then(data => {
                // Ưu tiên sử dụng displayName (Tên hiển thị) nếu có, nếu không thì dùng username
                username = data.displayName || data.username;
                document.querySelector('#username-page').classList.add('hidden');
                fetchUserList(); // Lấy danh sách user thay vì vào chat ngay
                document.querySelector('#logout-btn').classList.remove('hidden'); // Hiện nút đăng xuất
                connectWebSocket(); // Kết nối socket sẵn
            }).catch(err => alert("Sai tài khoản hoặc mật khẩu!"));
        }

        function logout() {
            if (stompClient) {
                stompClient.disconnect(); // Ngắt kết nối WebSocket
            }
            username = null;
            // Xóa tất cả cửa sổ chat
            Object.keys(activeChats).forEach(u => closeChatWindow(u));
            activeChats = {};
            document.querySelector('#user-list-page').classList.add('hidden');
            document.querySelector('#logout-btn').classList.add('hidden'); // Ẩn nút đăng xuất
            document.querySelector('#username-page').classList.remove('hidden');
        }

        // QUẢN LÝ DANH SÁCH USER
        function fetchUserList() {
            fetch('/api/auth/users')
                .then(res => res.json())
                .then(users => {
                    allUsers = users.filter(u => u.username !== document.querySelector('#login-username').value.trim()); // Loại bỏ chính mình
                    renderUserList();
                    document.querySelector('#user-list-page').classList.remove('hidden');
                });
        }

        function renderUserList() {
            const grid = document.querySelector('#user-grid');
            grid.innerHTML = '';
            allUsers.forEach(user => {
                const name = user.displayName || user.username;
                const card = document.createElement('div');
                card.className = 'user-card';
                card.onclick = () => startChat(user);

                const avatar = document.createElement('div');
                avatar.className = 'user-avatar-large';
                avatar.textContent = name.charAt(0);
                avatar.style.backgroundColor = getAvatarColor(name);

                const nameTag = document.createElement('div');
                nameTag.className = 'user-name-display';
                nameTag.textContent = name;

                card.append(avatar, nameTag);
                grid.appendChild(card);
            });
        }

        function startChat(partnerUser) {
            const partnerUsername = partnerUser.username;
            const partnerName = partnerUser.displayName || partnerUser.username;
            
            // Nếu đã mở rồi thì không làm gì (hoặc có thể focus vào nó)
            if (activeChats[partnerUsername]) return;

            // Tính toán Room ID
            const myName = document.querySelector('#login-username').value.trim();
            const roomId = [myName, partnerUsername].sort().join('_');

            createChatWindowUI(partnerUser, roomId);
            subscribeToRoom(partnerUsername, roomId);
            loadChatHistory(roomId, partnerUsername);
        }

        function createChatWindowUI(partnerUser, roomId) {
            const partnerUsername = partnerUser.username;
            const partnerName = partnerUser.displayName || partnerUser.username;

            // Tạo khung chat
            const chatWindow = document.createElement('div');
            chatWindow.className = 'chat-window';
            chatWindow.id = 'chat-window-' + partnerUsername;
            
            // Tính toán vị trí (cách phải 20px, mỗi cửa sổ cách nhau 340px)
            const offset = 20 + (Object.keys(activeChats).length * 340);
            chatWindow.style.right = offset + 'px';

            chatWindow.innerHTML = `
                <div class="chat-window-header">
                    <span class="chat-window-title">${partnerName}</span>
                    <button class="close-chat-btn" onclick="closeChatWindow('${partnerUsername}')">&times;</button>
                </div>
                <ul class="chat-window-body" id="msg-area-${partnerUsername}"></ul>
                <div class="chat-window-footer">
                    <form onsubmit="sendMessage(event, '${partnerUsername}')">
                        <input type="text" placeholder="Nhập tin nhắn..." autocomplete="off"/>
                        <button type="submit">Gửi</button>
                    </form>
                </div>
            `;

            document.body.appendChild(chatWindow);
            
            // Lưu vào state
            activeChats[partnerUsername] = {
                element: chatWindow,
                roomId: roomId,
                subscription: null
            };
        }

        function closeChatWindow(partnerUsername) {
            if (activeChats[partnerUsername]) {
                // Hủy đăng ký socket
                if (activeChats[partnerUsername].subscription) {
                    activeChats[partnerUsername].subscription.unsubscribe();
                }
                // Xóa DOM
                activeChats[partnerUsername].element.remove();
                delete activeChats[partnerUsername];
                
                // Sắp xếp lại vị trí các cửa sổ còn lại
                repositionChatWindows();
            }
        }

        function repositionChatWindows() {
            const keys = Object.keys(activeChats);
            keys.forEach((key, index) => {
                const offset = 20 + (index * 340);
                activeChats[key].element.style.right = offset + 'px';
            });
        }

        function loadChatHistory(roomId, partnerUsername) {
            fetch('/api/messages/' + roomId)
                .then(res => res.json())
                .then(messages => {
                    messages.forEach(msg => drawMessage(msg, partnerUsername));
                });
        }

        // WEBSOCKET LOGIC
        function connectWebSocket() {
            var socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, () => console.log("Connected"), onError); 
        }

        function subscribeToRoom(partnerUsername, roomId) {
            if (!stompClient) return;
            const topic = `/topic/${roomId}`;
            
            // Đăng ký và lưu subscription vào activeChats để sau này hủy
            const sub = stompClient.subscribe(topic, (payload) => {
                const msg = JSON.parse(payload.body);
                drawMessage(msg, partnerUsername);
            });
            
            if (activeChats[partnerUsername]) {
                activeChats[partnerUsername].subscription = sub;
            }
        }

        function onError(error) { console.error("Lỗi: " + error); }

        // Hàm tạo màu ngẫu nhiên dựa trên tên để avatar sinh động hơn
        function getAvatarColor(name) {
            var hash = 0;
            for (var i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            var c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function drawMessage(message, partnerUsername) {
            // Tìm đúng khung chat để vẽ tin nhắn
            var messageArea = document.querySelector(`#msg-area-${partnerUsername}`);
            if (!messageArea) return; // Nếu cửa sổ chat đã đóng thì bỏ qua

            var messageLi = document.createElement('li');

            if(message.type === 'JOIN' || message.type === 'LEAVE') {
                messageLi.classList.add('event-message');
                messageLi.textContent = message.sender + (message.type === 'JOIN' ? " đã tham gia phòng" : " đã rời phòng");
            } else {
                var contentContainer = document.createElement('div');
                contentContainer.classList.add('message-content');
                if (message.sender === username) {
                    messageLi.classList.add('my-message-container');
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'my-bubble');
                    bubble.textContent = message.content;
                    contentContainer.appendChild(bubble);
                } else {
                    messageLi.classList.add('other-message-container');
                    var avatar = document.createElement('div');
                    avatar.classList.add('avatar');
                    avatar.textContent = message.sender.charAt(0); // Lấy chữ cái đầu
                    avatar.style.backgroundColor = getAvatarColor(message.sender);
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'other-bubble');
                    bubble.textContent = message.content;
                    contentContainer.append(avatar, bubble);
                }
                messageLi.appendChild(contentContainer);
            }
            messageArea.appendChild(messageLi);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function sendMessage(event, partnerUsername) {
            event.preventDefault(); // Ngăn reload trang
            
            // Tìm input trong form vừa submit
            var input = event.target.querySelector('input');
            var content = input.value.trim();
            
            if(content && stompClient && activeChats[partnerUsername]) {
                const roomId = activeChats[partnerUsername].roomId;
                
                // Gửi tin nhắn. Lưu ý: Backend cần hỗ trợ nhận tham số roomId hoặc destination
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                    sender: username, 
                    content: content, 
                    type: 'CHAT',
                    roomId: roomId 
                }));
                
                input.value = '';
            }
        }
    </script>
</body>
</html>