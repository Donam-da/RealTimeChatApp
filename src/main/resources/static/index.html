<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App - Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

    <div id="username-page">
        <div class="username-page-container">
            <div id="login-section">
                <h1 class="title">Đăng nhập</h1>
                <input type="text" id="login-username" placeholder="Tài khoản" autocomplete="off" />
                <input type="password" id="login-password" placeholder="Mật khẩu" />
                <button onclick="login()" class="accent username-submit">Đăng nhập</button>
                <p class="toggle-text">Chưa có tài khoản? <span onclick="showRegister()">Đăng ký ngay</span></p>
            </div>

            <div id="register-section" class="hidden">
                <h1 class="title">Đăng ký tài khoản</h1>
                <input type="text" id="reg-username" placeholder="Tên đăng nhập mới" autocomplete="off" />
                <input type="password" id="reg-password" placeholder="Mật khẩu mới" />
                <button onclick="register()" class="accent username-submit" style="background-color: #0084ff;">Tạo tài khoản</button>
                <p class="toggle-text">Đã có tài khoản? <span onclick="showLogin()">Quay lại Đăng nhập</span></p>
            </div>
        </div>
    </div>

    <div id="chat-page" class="hidden">
		<div class="chat-header">
		    <div class="header-info">
		        <h2 class="title" id="display-username">User Name</h2>
		        <span class="status">Đang hoạt động</span>
		    </div>
		    <div class="header-menu">
		        <button class="menu-btn" onclick="toggleMenu()">&#8942;</button>
		        <div id="chat-menu" class="dropdown-menu hidden">
		            <button onclick="clearChatHistory()" class="delete-btn">Xóa đoạn chat</button>
		        </div>
		    </div>
		</div>

        <div class="chat-container">
            <ul id="messageArea"></ul>
            <form id="messageForm" name="messageForm">
                <input type="text" id="message" placeholder="Nhập tin nhắn..." autocomplete="off"/>
                <button type="submit">Gửi</button>
            </form>
        </div>
    </div>

    <script>
        var stompClient = null;
        var username = null; 
        var avatarUrl = "https://i.imgur.com/DY6gND0.png"; 

        // 1. CÁC HÀM CHUYỂN ĐỔI GIAO DIỆN (Sửa lỗi đứng yên trang)
        function showRegister() {
            document.querySelector('#login-section').classList.add('hidden');
            document.querySelector('#register-section').classList.remove('hidden');
        }

        function showLogin() {
            document.querySelector('#register-section').classList.add('hidden');
            document.querySelector('#login-section').classList.remove('hidden');
        }

        // 2. HÀM ĐĂNG KÝ (Gửi dữ liệu tới AuthController)
        function register() {
            const u = document.querySelector('#reg-username').value.trim();
            const p = document.querySelector('#reg-password').value.trim();

            if(!u || !p) { alert("Vui lòng nhập đủ tài khoản và mật khẩu"); return; }

            fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            })
            .then(res => res.text())
            .then(data => {
                alert(data);
                if(data === "Đăng ký thành công!") showLogin();
            });
        }

        // 3. HÀM ĐĂNG NHẬP
        function login() {
            const u = document.querySelector('#login-username').value.trim();
            const p = document.querySelector('#login-password').value.trim();

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            })
            .then(res => {
                if(res.ok) {
                    username = u;
                    document.querySelector('#username-page').classList.add('hidden');
                    document.querySelector('#chat-page').classList.remove('hidden');
                    document.querySelector('#display-username').textContent = username;
                    startWebSocket(); // Bắt đầu kết nối chat
                } else {
                    alert("Sai tài khoản hoặc mật khẩu!");
                }
            });
        }

        // === LOGIC CHAT WEBSOCKET ===
        function startWebSocket() {
            var socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, onConnected, onError); 
        }

        function onConnected() {
            stompClient.subscribe('/topic/public', onMessageReceived);
            
            // Tải lịch sử
            fetch('/chat/history')
                .then(res => res.json())
                .then(msgs => msgs.forEach(drawMessage));

            stompClient.send("/app/chat.addUser", {}, JSON.stringify({sender: username, type: 'JOIN'}));
        }

        function onError(error) {
            console.error("Lỗi: " + error);
        }

        function drawMessage(message) {
            var messageArea = document.querySelector('#messageArea');
            var messageLi = document.createElement('li');

            if(message.type === 'JOIN' || message.type === 'LEAVE') {
                messageLi.classList.add('event-message');
                messageLi.textContent = message.sender + (message.type === 'JOIN' ? " đã tham gia phòng" : " đã rời phòng");
            } else {
                var contentContainer = document.createElement('div');
                contentContainer.classList.add('message-content');

                if (message.sender === username) {
                    messageLi.classList.add('my-message-container');
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'my-bubble');
                    bubble.textContent = message.content;
                    contentContainer.appendChild(bubble);
                } else {
                    messageLi.classList.add('other-message-container');
                    var avatar = document.createElement('img');
                    avatar.src = avatarUrl;
                    avatar.classList.add('avatar');
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'other-bubble');
                    var senderName = document.createElement('div');
                    senderName.classList.add('sender-name');
                    senderName.textContent = message.sender;
                    var text = document.createElement('div');
                    text.textContent = message.content;
                    bubble.append(senderName, text);
                    contentContainer.append(avatar, bubble);
                }
                messageLi.appendChild(contentContainer);
            }
            messageArea.appendChild(messageLi);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function onMessageReceived(payload) {
            drawMessage(JSON.parse(payload.body));
        }

        function sendMessage(event) {
            var input = document.querySelector('#message');
            var content = input.value.trim();
            if(content && stompClient) {
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({sender: username, content: content, type: 'CHAT'}));
                input.value = '';
            }
            event.preventDefault();
        }
		// Đóng/mở menu ba chấm
		function toggleMenu() {
		    document.querySelector('#chat-menu').classList.toggle('hidden');
		}

		// Gọi API xóa lịch sử
		function clearChatHistory() {
		    if (confirm("Bạn có chắc chắn muốn xóa toàn bộ tin nhắn?")) {
		        fetch('/chat/clear', { method: 'DELETE' })
		            .then(res => {
		                if (res.ok) {
		                    document.querySelector('#messageArea').innerHTML = ''; // Xóa tin nhắn trên màn hình
		                    toggleMenu(); // Đóng menu
		                }
		            });
		    }
		}

		// Đóng menu khi nhấn ra ngoài
		window.onclick = function(e) {
		    if (!e.target.matches('.menu-btn')) {
		        document.querySelector('#chat-menu').classList.add('hidden');
		    }
		}

        document.querySelector('#messageForm').addEventListener('submit', sendMessage, true);
    </script>
</body>
</html>