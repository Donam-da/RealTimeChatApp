<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App - Pro</title>
    <link rel="stylesheet" href="style.css?v=1.7">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Nút đăng xuất toàn cục -->
    <button onclick="logout()" id="logout-btn" class="logout-btn hidden">Đăng xuất</button>

    <div id="username-page">
        <div class="username-page-container">
            <div id="login-section">
                <h1 class="title">Đăng nhập</h1>
                <input type="text" id="login-username" placeholder="Tài khoản" autocomplete="off" />
                <input type="password" id="login-password" placeholder="Mật khẩu" />
                <button onclick="login()" class="accent username-submit">Đăng nhập</button>
                <p class="toggle-text">Chưa có tài khoản? <span onclick="showRegister()">Đăng ký ngay</span></p>
            </div>

            <div id="register-section" class="hidden">
                <h1 class="title">Đăng ký tài khoản</h1>
                <input type="text" id="reg-username" placeholder="Tên đăng nhập mới" autocomplete="off" />
                <input type="password" id="reg-password" placeholder="Mật khẩu mới" />
                <input type="text" id="reg-displayname" placeholder="Tên hiển thị (Tùy chọn)" autocomplete="off" />
                <button onclick="register()" class="accent username-submit" style="background-color: #0084ff;">Tạo tài khoản</button>
                <p class="toggle-text">Đã có tài khoản? <span onclick="showLogin()">Quay lại Đăng nhập</span></p>
            </div>
        </div>
    </div>

    <!-- Màn hình danh sách người dùng -->
    <div id="user-list-page" class="hidden">
        <h2 class="title" style="margin-bottom: 20px;">Chọn người để chat</h2>
        <div id="user-grid" class="user-grid">
            <!-- Các icon user sẽ được thêm vào đây bằng JS -->
        </div>
    </div>

    <script>
        var stompClient = null;
        var username = null; 
        var myDisplayName = null; // Biến lưu tên hiển thị của mình
        var activeChats = {}; // Lưu trữ các cửa sổ chat đang mở: { 'username': { element, subscription, roomId } }
        var allUsers = []; // Danh sách user

        // CHUYỂN ĐỔI GIAO DIỆN
        function showRegister() {
            document.querySelector('#login-section').classList.add('hidden');
            document.querySelector('#register-section').classList.remove('hidden');
        }

        function showLogin() {
            document.querySelector('#register-section').classList.add('hidden');
            document.querySelector('#login-section').classList.remove('hidden');
        }

        // ĐĂNG KÝ & ĐĂNG NHẬP
        function register() {
            const u = document.querySelector('#reg-username').value.trim();
            const p = document.querySelector('#reg-password').value.trim();
            const dn = document.querySelector('#reg-displayname').value.trim();
            if(!u || !p) { alert("Vui lòng nhập đủ tài khoản và mật khẩu"); return; }

            fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p, displayName: dn})
            }).then(res => res.text()).then(data => {
                alert(data);
                if(data === "Đăng ký thành công!") showLogin();
            });
        }

        function login() {
            const u = document.querySelector('#login-username').value.trim();
            const p = document.querySelector('#login-password').value.trim();

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            }).then(res => {
                if(res.ok) {
                    return res.json(); // Chuyển đổi phản hồi từ server sang JSON
                } else { throw new Error("Login failed"); }
            }).then(data => {
                // Ưu tiên sử dụng displayName (Tên hiển thị) nếu có, nếu không thì dùng username
                username = data.username; // QUAN TRỌNG: Giữ nguyên username gốc để định danh
                myDisplayName = data.displayName || data.username; // Lưu tên hiển thị riêng
                document.querySelector('#username-page').classList.add('hidden');
                fetchUserList(); // Lấy danh sách user thay vì vào chat ngay
                document.querySelector('#logout-btn').classList.remove('hidden'); // Hiện nút đăng xuất
                connectWebSocket(); // Kết nối socket sẵn
            }).catch(err => alert("Sai tài khoản hoặc mật khẩu!"));
        }

        function logout() {
            // Gọi API logout để cập nhật trạng thái Offline trên server
            if (username) {
                fetch('/api/auth/logout', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: username}) });
            }

            if (stompClient) {
                stompClient.disconnect(); // Ngắt kết nối WebSocket
            }
            username = null;
            // Xóa tất cả cửa sổ chat
            Object.keys(activeChats).forEach(u => closeChatWindow(u));
            activeChats = {};
            document.querySelector('#user-list-page').classList.add('hidden');
            document.querySelector('#logout-btn').classList.add('hidden'); // Ẩn nút đăng xuất
            document.querySelector('#username-page').classList.remove('hidden');
        }

        // QUẢN LÝ DANH SÁCH USER
        function fetchUserList() {
            fetch('/api/auth/users')
                .then(res => res.json())
                .then(users => {
                    allUsers = users.filter(u => u.username !== document.querySelector('#login-username').value.trim()); // Loại bỏ chính mình
                    // Cập nhật lại trạng thái cho các cửa sổ chat đang mở (nếu có)
                    allUsers.forEach(u => {
                        if (activeChats[u.username]) {
                            updateStatusUI(u.username, u.status, u.lastActive);
                        }
                    });
                    renderUserList();
                    document.querySelector('#user-list-page').classList.remove('hidden');
                });
        }

        function renderUserList() {
            const grid = document.querySelector('#user-grid');
            grid.innerHTML = '';
            allUsers.forEach(user => {
                const name = user.displayName || user.username;
                const card = document.createElement('div');
                card.className = 'user-card';
                card.onclick = () => startChat(user);

                // Container bọc avatar để định vị chấm trạng thái
                const avatarContainer = document.createElement('div');
                avatarContainer.className = 'user-avatar-container';

                const avatar = document.createElement('div');
                avatar.className = 'user-avatar-large';
                avatar.textContent = name.charAt(0);
                avatar.style.backgroundColor = getAvatarColor(name);

                // Badge trạng thái
                const statusBadge = document.createElement('div');
                statusBadge.className = 'status-badge';
                if (user.status === 'ONLINE') statusBadge.classList.add('status-online');
                else { statusBadge.classList.add('status-offline'); statusBadge.textContent = getShortTime(user.lastActive); }

                avatarContainer.append(avatar, statusBadge);
                const nameTag = document.createElement('div');
                nameTag.className = 'user-name-display';
                nameTag.textContent = name;

                card.append(avatarContainer, nameTag);
                grid.appendChild(card);
            });
        }

        function startChat(partnerUser) {
            const partnerUsername = partnerUser.username;
            const partnerName = partnerUser.displayName || partnerUser.username;
            
            // Nếu đã mở rồi thì không làm gì (hoặc có thể focus vào nó)
            if (activeChats[partnerUsername]) return;

            // Tính toán Room ID
            const myName = document.querySelector('#login-username').value.trim();
            const roomId = [myName, partnerUsername].sort().join('_');

            createChatWindowUI(partnerUser, roomId);
            subscribeToRoom(partnerUsername, roomId);
            loadChatHistory(roomId, partnerUsername, partnerName);
            sendReadReceipt(partnerUsername, roomId); // Báo đã xem ngay khi mở chat
            updateStatusUI(partnerUsername, partnerUser.status, partnerUser.lastActive); // Hiển thị trạng thái ban đầu
        }

        function createChatWindowUI(partnerUser, roomId) {
            const partnerUsername = partnerUser.username;
            const partnerName = partnerUser.displayName || partnerUser.username;

            // Tạo khung chat
            const chatWindow = document.createElement('div');
            chatWindow.className = 'chat-window';
            chatWindow.id = 'chat-window-' + partnerUsername;
            
            // Tính toán vị trí (cách phải 20px, mỗi cửa sổ cách nhau 340px)
            const offset = 20 + (Object.keys(activeChats).length * 340);
            chatWindow.style.right = offset + 'px';

            chatWindow.innerHTML = `
                <div class="chat-window-header">
                    <div style="display: flex; align-items: center;">
                        <div style="display: flex; flex-direction: column;">
                            <div style="display: flex; align-items: center;">
                                <span class="chat-window-title">${partnerName}</span>
                                <div class="dropdown">
                                    <button class="dropdown-btn" onclick="toggleDropdown('${partnerUsername}')">&#9662;</button>
                                    <div id="dropdown-${partnerUsername}" class="dropdown-content">
                                        <a href="#" onclick="deleteChat('${partnerUsername}')">Xóa đoạn chat</a>
                                    </div>
                                </div>
                            </div>
                            <span class="chat-window-status" id="status-${partnerUsername}">Đang tải...</span>
                        </div>
                    </div>
                    <button class="close-chat-btn" onclick="closeChatWindow('${partnerUsername}')">&times;</button>
                </div>
                <ul class="chat-window-body" id="msg-area-${partnerUsername}"></ul>
                <div class="chat-window-footer">
                    <div id="typing-${partnerUsername}" class="typing-indicator"></div>
                    <form onsubmit="sendMessage(event, '${partnerUsername}')">
                        <textarea placeholder="Nhập tin nhắn..." rows="1" oninput="autoResize(this); handleTyping('${partnerUsername}')" onkeydown="handleEnter(event, '${partnerUsername}')"></textarea>
                        <button type="submit">Gửi</button>
                    </form>
                </div>
            `;

            document.body.appendChild(chatWindow);
            
            // Lưu vào state
            activeChats[partnerUsername] = {
                element: chatWindow,
                roomId: roomId,
                subscription: null,
                typingTimeout: null, // Để quản lý thời gian ẩn thông báo
                status: partnerUser.status,
                lastActive: partnerUser.lastActive
            };
        }

        function closeChatWindow(partnerUsername) {
            if (activeChats[partnerUsername]) {
                // Hủy đăng ký socket
                if (activeChats[partnerUsername].subscription) {
                    activeChats[partnerUsername].subscription.unsubscribe();
                }
                // Xóa DOM
                activeChats[partnerUsername].element.remove();
                delete activeChats[partnerUsername];
                
                // Sắp xếp lại vị trí các cửa sổ còn lại
                repositionChatWindows();
            }
        }

        function repositionChatWindows() {
            const keys = Object.keys(activeChats);
            keys.forEach((key, index) => {
                const offset = 20 + (index * 340);
                activeChats[key].element.style.right = offset + 'px';
            });
        }

        // --- DROPDOWN & DELETE CHAT ---
        function toggleDropdown(username) {
            document.getElementById("dropdown-" + username).classList.toggle("show");
        }

        // Đóng dropdown khi click ra ngoài
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function deleteChat(partnerUsername) {
            if (!confirm("Bạn có chắc muốn xóa toàn bộ tin nhắn với người này?")) return;
            
            const roomId = activeChats[partnerUsername].roomId;
            // Truyền thêm username để server biết ai đang xóa
            fetch('/api/messages/' + roomId + '?username=' + username, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        document.querySelector('#msg-area-' + partnerUsername).innerHTML = '';
                        alert("Đã xóa đoạn chat!");
                    } else {
                        alert("Lỗi khi xóa chat");
                    }
                });
        }

        function loadChatHistory(roomId, partnerUsername, partnerName) {
            // Truyền thêm username để server lọc tin nhắn đã xóa
            fetch('/api/messages/' + roomId + '?username=' + username)
                .then(res => res.json())
                .then(messages => {
                    messages.forEach(msg => drawMessage(msg, partnerUsername));
                    
                    // Sau khi tải lịch sử, kiểm tra xem tin nhắn cuối cùng của mình đã được xem chưa
                    const myMsgs = messages.filter(m => m.sender === username);
                    if (myMsgs.length > 0) {
                        const lastMsg = myMsgs[myMsgs.length - 1];
                        if (lastMsg.status === 'READ') {
                            // Giả lập sự kiện READ để vẽ icon
                            drawMessage({ type: 'READ', sender: partnerUsername }, partnerUsername);
                        }
                    }
                });
        }

        // WEBSOCKET LOGIC
        function connectWebSocket() {
            var socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
                console.log("Connected");
                subscribeToPresence(); // Lắng nghe trạng thái Online/Offline
            }, onError); 
        }

        // Lắng nghe trạng thái người dùng toàn cục
        function subscribeToPresence() {
            stompClient.subscribe('/topic/presence', (payload) => {
                const msg = JSON.parse(payload.body);
                if (msg.type === 'STATUS') {
                    // Cập nhật UI nếu đang mở chat với người này
                    if (activeChats[msg.sender]) {
                        updateStatusUI(msg.sender, msg.content, msg.timestamp);
                    }
                    // Cập nhật danh sách user ngầm định (để lần sau mở chat có dữ liệu mới)
                    const userInList = allUsers.find(u => u.username === msg.sender);
                    if (userInList) {
                        userInList.status = msg.content;
                        userInList.lastActive = msg.timestamp;
                        // Nếu đang ở trang danh sách thì render lại ngay để cập nhật chấm xanh
                        if (!document.querySelector('#user-list-page').classList.contains('hidden')) {
                            renderUserList();
                        }
                    }
                }
            });
        }

        function subscribeToRoom(partnerUsername, roomId) {
            if (!stompClient) return;
            const topic = `/topic/${roomId}`;
            
            // Đăng ký và lưu subscription vào activeChats để sau này hủy
            const sub = stompClient.subscribe(topic, (payload) => {
                const msg = JSON.parse(payload.body);
                drawMessage(msg, partnerUsername);
                // Nếu nhận được tin nhắn CHAT từ người kia, báo đã xem ngay
                if (msg.type === 'CHAT' && msg.sender !== username) {
                    sendReadReceipt(partnerUsername, roomId);
                }
                // Xử lý sự kiện TYPING
                if (msg.type === 'TYPING' && msg.sender !== username) {
                    showTypingIndicator(partnerUsername, msg.sender);
                }
            });
            
            if (activeChats[partnerUsername]) {
                activeChats[partnerUsername].subscription = sub;
            }
        }

        function onError(error) { console.error("Lỗi: " + error); }

        // Tự động đăng xuất khi đóng tab/trình duyệt
        window.addEventListener('beforeunload', function (e) {
            if (username) {
                var data = JSON.stringify({username: username});
                var blob = new Blob([data], {type: 'application/json'});
                navigator.sendBeacon('/api/auth/logout', blob);
            }
        });

        // Hàm tạo màu ngẫu nhiên dựa trên tên để avatar sinh động hơn
        function getAvatarColor(name) {
            var hash = 0;
            for (var i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            var c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function getDisplayName(userId) {
            if (userId === username) return myDisplayName;
            const u = allUsers.find(user => user.username === userId);
            return u ? (u.displayName || u.username) : userId;
        }

        function drawMessage(message, partnerUsername) {
            // Tìm đúng khung chat để vẽ tin nhắn
            var messageArea = document.querySelector(`#msg-area-${partnerUsername}`);
            if (!messageArea) return; // Nếu cửa sổ chat đã đóng thì bỏ qua

            var messageLi = document.createElement('li');

            // Xử lý sự kiện ĐÃ XEM (READ)
            if (message.type === 'READ') {
                if (message.sender !== username) { // Người kia đã đọc tin nhắn của mình
                    // Xóa icon cũ
                    const oldIcons = document.querySelectorAll(`#msg-area-${partnerUsername} .seen-icon`);
                    oldIcons.forEach(el => el.remove());

                    // Tìm tin nhắn cuối cùng của mình để gắn icon
                    const myMsgs = document.querySelectorAll(`#msg-area-${partnerUsername} .my-message-container`);
                    if(myMsgs.length > 0) {
                        const lastMsg = myMsgs[myMsgs.length - 1];
                        addSeenIcon(lastMsg, message.sender);
                    }
                }
                return; // Không vẽ tin nhắn, chỉ xử lý icon
            }

            // Xử lý sự kiện TYPING (Không vẽ tin nhắn)
            if (message.type === 'TYPING') {
                return;
            }

            // --- XỬ LÝ DÒNG THỜI GIAN (SEPARATOR) ---
            var currentMsgDate = parseDate(message.timestamp);
            var currentTimestamp = currentMsgDate ? currentMsgDate.getTime() : Date.now();
            
            // Tìm tin nhắn gần nhất trước đó (có attribute data-timestamp)
            const previousMsgs = messageArea.querySelectorAll('li[data-timestamp]');
            
            if (previousMsgs.length === 0) {
                addDateSeparator(message.timestamp, partnerUsername);
            } else {
                const lastMsg = previousMsgs[previousMsgs.length - 1];
                const lastTimestamp = parseInt(lastMsg.getAttribute('data-timestamp'));
                // Nếu cách nhau quá 5 phút (300000 ms) thì hiện lại dòng thời gian
                if (currentTimestamp - lastTimestamp > 5 * 60 * 1000) {
                    addDateSeparator(message.timestamp, partnerUsername);
                }
            }
            
            // Lưu timestamp vào thẻ li để dùng cho lần so sánh tiếp theo
            messageLi.setAttribute('data-timestamp', currentTimestamp);

            if(message.type === 'JOIN' || message.type === 'LEAVE') {
                messageLi.classList.add('event-message');
                messageLi.textContent = message.sender + (message.type === 'JOIN' ? " đã tham gia phòng" : " đã rời phòng");
            } else {
                var senderDisplayName = getDisplayName(message.sender);
                var timeString = formatTime(message.timestamp); // Lấy giờ:phút
                var contentContainer = document.createElement('div');
                contentContainer.classList.add('message-content');
                if (message.sender === username) {
                    messageLi.classList.add('my-message-container');
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'my-bubble');
                    bubble.textContent = message.content;
                    if (timeString) bubble.innerHTML += `<span class="message-time">${timeString}</span>`;
                    contentContainer.appendChild(bubble);
                } else {
                    messageLi.classList.add('other-message-container');
                    var avatar = document.createElement('div');
                    avatar.classList.add('avatar');
                    avatar.textContent = senderDisplayName.charAt(0); // Lấy chữ cái đầu của tên hiển thị
                    avatar.style.backgroundColor = getAvatarColor(senderDisplayName);
                    var bubble = document.createElement('div');
                    bubble.classList.add('bubble', 'other-bubble');
                    bubble.textContent = message.content;
                    if (timeString) bubble.innerHTML += `<span class="message-time">${timeString}</span>`;
                    contentContainer.append(avatar, bubble);
                }
                messageLi.appendChild(contentContainer);
            }
            messageArea.appendChild(messageLi);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function addDateSeparator(timestamp, partnerUsername) {
            var messageArea = document.querySelector(`#msg-area-${partnerUsername}`);
            if (!messageArea) return;
            
            var li = document.createElement('li');
            li.className = 'date-separator';
            li.textContent = formatFullDate(timestamp);
            messageArea.appendChild(li);
        }

        function addSeenIcon(container, partnerUsername) {
            var displayName = getDisplayName(partnerUsername);
            const icon = document.createElement('div');
            icon.className = 'seen-icon';
            icon.style.backgroundColor = getAvatarColor(displayName);
            icon.textContent = displayName.charAt(0);
            container.appendChild(icon);
        }

        function sendReadReceipt(partnerUsername, roomId) {
            if(stompClient && activeChats[partnerUsername]) {
                stompClient.send("/app/chat.read", {}, JSON.stringify({
                    sender: username, // Tôi là người đọc
                    type: 'READ',
                    roomId: roomId
                }));
            }
        }

        // --- LOGIC ĐANG SOẠN TIN (TYPING) ---
        var lastTypingTime = 0;
        function handleTyping(partnerUsername) {
            const now = Date.now();
            // Chỉ gửi sự kiện mỗi 2 giây để tránh spam server
            if (now - lastTypingTime > 2000 && stompClient && activeChats[partnerUsername]) {
                const roomId = activeChats[partnerUsername].roomId;
                stompClient.send("/app/chat.typing", {}, JSON.stringify({
                    sender: username,
                    type: 'TYPING',
                    roomId: roomId
                }));
                lastTypingTime = now;
            }
        }

        function showTypingIndicator(partnerUsername, senderUsername) {
            const indicator = document.getElementById(`typing-${partnerUsername}`);
            if (!indicator) return;

            // Lấy tên hiển thị thực tế từ username, sau đó mới lấy tên cuối
            const displayName = getDisplayName(senderUsername);
            const nameParts = displayName.trim().split(/\s+/);
            const lastName = nameParts[nameParts.length - 1];

            indicator.textContent = `... ${lastName} đang soạn tin nhắn`;
            indicator.classList.add('visible');

            // Xóa timeout cũ và đặt timeout mới để ẩn thông báo sau 3 giây
            if (activeChats[partnerUsername].typingTimeout) clearTimeout(activeChats[partnerUsername].typingTimeout);
            activeChats[partnerUsername].typingTimeout = setTimeout(() => {
                indicator.classList.remove('visible');
            }, 3000);
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto'; // Reset để tính toán lại
            textarea.style.height = textarea.scrollHeight + 'px'; // Gán chiều cao theo nội dung
        }

        function handleEnter(event, partnerUsername) {
            // Nếu nhấn Enter mà không giữ Shift -> Gửi tin nhắn
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event, partnerUsername);
            }
        }

        function sendMessage(event, partnerUsername) {
            if(event.preventDefault) event.preventDefault(); // Ngăn reload trang
            
            // Tìm input trong form vừa submit
            var form = event.target.tagName === 'FORM' ? event.target : event.target.closest('form');
            var input = form.querySelector('textarea');
            var content = input.value.trim();
            
            if(content && stompClient && activeChats[partnerUsername]) {
                const roomId = activeChats[partnerUsername].roomId;
                
                // Gửi tin nhắn. Lưu ý: Backend cần hỗ trợ nhận tham số roomId hoặc destination
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                    sender: username, 
                    content: content, 
                    type: 'CHAT',
                    roomId: roomId 
                }));
                
                input.value = '';
                input.style.height = 'auto'; // Reset chiều cao về 1 dòng
            }
        }

        // --- HÀM XỬ LÝ TRẠNG THÁI & THỜI GIAN ---
        function updateStatusUI(username, status, lastActive) {
            const statusEl = document.getElementById(`status-${username}`);
            if (!statusEl) return;

            // Cập nhật dữ liệu vào activeChats để setInterval có thể dùng lại
            if (activeChats[username]) {
                activeChats[username].status = status;
                activeChats[username].lastActive = lastActive;
            }

            if (status === 'ONLINE') {
                statusEl.textContent = 'Đang hoạt động';
            } else {
                statusEl.textContent = 'Hoạt động ' + timeSince(lastActive);
            }
        }

        function parseDate(date) {
            if (!date) return null;
            // Xử lý trường hợp Java gửi về mảng [yyyy, MM, dd, HH, mm, ss]
            if (Array.isArray(date)) {
                return new Date(date[0], date[1] - 1, date[2], date[3], date[4], date[5]);
            }
            return new Date(date);
        }

        function formatTime(date) {
            var d = parseDate(date);
            if (!d) return "";
            var hours = d.getHours().toString().padStart(2, '0');
            var minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatFullDate(date) {
            var d = parseDate(date);
            if (!d) d = new Date(); // Fallback nếu không có time
            
            var now = new Date();
            var hours = d.getHours().toString().padStart(2, '0');
            var minutes = d.getMinutes().toString().padStart(2, '0');
            
            // So sánh ngày (bỏ qua giờ phút giây để tính khoảng cách ngày chính xác)
            var dZero = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            var nowZero = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var diffTime = nowZero - dZero;
            var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return `${hours}:${minutes}`;
            } else if (diffDays > 0 && diffDays < 7) {
                var days = ['Chủ Nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
                return `${hours}:${minutes} ${days[d.getDay()]}`;
            } else {
                var day = d.getDate().toString().padStart(2, '0');
                var month = (d.getMonth() + 1).toString().padStart(2, '0');
                var year = d.getFullYear();
                return `${hours}:${minutes} ${day} tháng ${month}, ${year}`;
            }
        }

        function timeSince(date) {
            date = parseDate(date);
            if (!date) return "vài phút trước";
            var seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return "1 phút trước"; // Hiển thị ngay lập tức
            
            var interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " năm trước";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " tháng trước";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ngày trước";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " giờ trước";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " phút trước";
            return "Vừa xong";
        }

        function getShortTime(date) {
            date = parseDate(date);
            if (!date) return "";
            var seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return "1p";
            var minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + "p";
            var hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + "h";
            var days = Math.floor(hours / 24);
            return days + "d";
        }

        // Tự động cập nhật thời gian "Hoạt động X phút trước" mỗi phút
        setInterval(() => {
            Object.keys(activeChats).forEach(username => {
                const chat = activeChats[username];
                if (chat.status !== 'ONLINE') {
                    updateStatusUI(username, chat.status, chat.lastActive);
                }
            });
            // Cập nhật danh sách user (nếu đang hiển thị) để update thời gian offline (ví dụ 1p -> 2p)
            if (!document.querySelector('#user-list-page').classList.contains('hidden')) {
                renderUserList();
            }
        }, 60000);
    </script>
</body>
</html>